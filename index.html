<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Moon Week Posting</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5', /* Indigo */
                        'secondary': '#10b981', /* Emerald */
                        'background': '#f9fafb',
                        'accent': '#f59e0b', /* Amber */
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better textarea visibility */
        textarea {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5;
            resize: vertical;
        }
        #rawDescription {
            min-height: 200px; /* Adjusted for compactness */
        }
        #tagsOnlyOutput {
            min-height: 200px; /* Increased height for 3b */
        }
        #defaultTagsInput {
            font-size: 0.8rem; /* Smaller font for global hashtags */
        }
        .tab-button.active {
            @apply border-b-4 border-primary text-primary font-semibold;
        }
        /* Aggressively compacting the list items in settings */
        .compact-list-item {
            padding-top: 0.15rem; /* Further reduced padding */
            padding-bottom: 0.15rem;
            font-size: 0.75rem; /* text-xs for list content */
            cursor: pointer; /* Indicate drag-and-drop area */
        }
        .compact-list-item span {
            font-size: 0.75rem;
        }
        /* Specific width for date picker */
        .date-input-container input[type="date"] {
            width: 150px; 
            max-width: 150px;
        }
        .sortable-drag {
            opacity: 0.6;
            background-color: #f1f5f9; /* Blue-gray for drag visual feedback */
        }
    </style>
</head>
<body class="bg-background min-h-screen p-4 sm:p-8 font-sans">
    
    <!-- FIREBASE AND DRAG-N-DROP IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, updateDoc, query, where, arrayRemove, arrayUnion, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for access by non-module script
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection, getDocs, updateDoc, query, where, arrayRemove, arrayUnion, setLogLevel };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6 p-4 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-gray-900">Full Moon Week Posting</h1>
        </header>
        
        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-xl shadow-md">
            <button id="tab-editor-btn" onclick="showTab('editor')" class="tab-button active flex-1 py-3 text-center transition duration-150">
                <svg class="w-5 h-5 inline mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002 2h2a2 2 0 002-2"></path></svg>
                Event
            </button>
            <button id="tab-settings-btn" onclick="showTab('settings')" class="tab-button flex-1 py-3 text-center transition duration-150">
                <svg class="w-5 h-5 inline mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.323 1.144.38 1.724.161v-4.04z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Settings
            </button>
            <button id="tab-scheduler-btn" onclick="showTab('scheduler')" class="tab-button flex-1 py-3 text-center transition duration-150">
                <svg class="w-5 h-5 inline mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Schedule
            </button>
        </div>

        <!-- MAIN EDITOR TAB -->
        <div id="tab-editor-content" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- INPUT COLUMN -->
                <div class="space-y-6">
                    <!-- Structured Event Input -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <label class="block text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            Event Details
                        </label>

                        <!-- EVENT TEMPLATE LOADER -->
                        <div class="mb-4">
                            <label for="eventTemplateSelect" class="block text-sm font-medium text-gray-700 mb-1">Load Event Template:</label>
                            <select id="eventTemplateSelect" onchange="loadEventTemplate()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                                <option value="">--- Select Event Template ---</option>
                            </select>
                        </div>

                        <div class="space-y-3">
                            <!-- DATE INPUT (DATEPICKER ONLY) -->
                            <div class="flex items-center date-input-container space-x-3">
                                <label for="inputIsoDate" class="flex-shrink-0 text-sm font-medium text-gray-700">🗓 Event Date:</label>
                                <input type="date" id="inputIsoDate" class="border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                            </div>
                            
                            <input type="text" id="inputEventName" placeholder="🎉 EVENT: " class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                            <input type="text" id="inputLocation" placeholder="📍 LOCATION: " class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                        </div>
                        
                        <label for="rawDescription" class="block text-xl font-semibold text-gray-900 mt-6 mb-2 flex items-center">
                            Full Description
                        </label>
                        <textarea id="rawDescription" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-primary focus:border-primary transition duration-150" placeholder=""></textarea>

                        <label for="extraHashtagsInput" class="block text-sm font-medium text-gray-700 mt-4 mb-2">
                            Extra Hashtags (Comma-separated)
                        </label>
                        <input type="text" id="extraHashtagsInput" placeholder="" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                    </div>
                    
                    <!-- File Mockup (NEW) -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                         <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            Images/Videos
                        </h2>
                        <input type="file" id="mediaUpload" class="w-full text-sm text-gray-500 border border-gray-300 rounded-lg p-2">
                        <button onclick="generateFileName()" class="mt-3 w-full py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">
                            Generate Suggested Filename
                        </button>
                        <p id="fileNameOutput" class="text-xs text-gray-700 mt-2 break-all"></p>
                    </div>
                </div>

                <!-- OUTPUT COLUMN -->
                <div class="space-y-6">
                    <!-- Calendar Output -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <label for="calendarOutput" class="block text-xl font-semibold text-gray-900 mb-2 flex items-center">
                            Post/Reel Text
                        </label>
                        <!-- Made editable -->
                        <textarea id="calendarOutput" class="w-full border border-gray-300 rounded-lg p-3 bg-white min-h-[350px]" placeholder="Formatted post data will appear here."></textarea>
                    </div>

                    <!-- Tags Only Output -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <label for="tagsOnlyOutput" class="block text-xl font-semibold text-gray-900 mb-2 flex items-center">
                            Story Tags
                        </label>
                        <!-- Made editable. FIX: Min height increased (7) -->
                        <textarea id="tagsOnlyOutput" class="w-full border border-gray-300 rounded-lg p-3 bg-gray-50 min-h-[200px]" placeholder="Only unique @tags, one per line, will appear here."></textarea>
                    </div>
                    
                    <!-- Action (Moved to Output Column - 2) -->
                    <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col sm:flex-row items-center justify-between">
                        <div id="statusMessage" class="mt-4 sm:mt-0 text-sm text-gray-600 w-full mb-3 sm:mb-0 text-center sm:text-left">Awaiting Firebase Connection...</div>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full">
                            <button id="parseButton" onclick="handleClick(false)" class="w-full sm:w-auto px-8 py-3 bg-primary text-white font-bold rounded-full shadow-md hover:bg-indigo-600 transition duration-300 transform hover:scale-105">
                                PARSE
                            </button>
                            <button id="saveScheduleButton" onclick="handleClick(true)" class="w-full sm:w-auto px-8 py-3 bg-accent text-white font-bold rounded-full shadow-md hover:bg-amber-600 transition duration-300 transform hover:scale-105">
                                SAVE TO SCHEDULE
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings-content" class="tab-content hidden">
            <!-- REVERSED GRID SPLIT: Database is 1/3, Settings/Templates is 2/3 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Database Management (Col 1/3) -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m-4 12v-2m4-10v2m-4 8v2m4-10v2m-4 8v2m4-10v2m-4 8v2m4-10v2m-4 8v2m4-10v2m-4 8v2m4-10v2"></path></svg>
                            Tags
                        </h2>
                        
                        <!-- Filter & Search -->
                        <div class="flex space-x-3 mb-4">
                            <select id="categoryFilter" onchange="renderNameMap()" class="p-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">All Categories</option>
                                <option value="DJ">DJ</option>
                                <option value="Venue">Venue</option>
                                <option value="Presenter">Presenter</option>
                                <option value="Artist">Artist</option>
                                <option value="Label">Label</option>
                                <option value="Other">Other</option>
                            </select>
                            <!-- FIX: Half width search input (8) -->
                            <input type="text" id="nameSearch" oninput="renderNameMap()" placeholder="Search by Name or Tag..." class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm">
                        </div>

                        <!-- Add New Entry Form -->
                        <div class="mb-6 p-4 border border-secondary/50 rounded-lg bg-secondary/10 space-y-3">
                            <h3 class="font-medium text-secondary">Add New Entry:</h3>
                            <input type="text" id="newName" placeholder="Name (e.g., John Smith)" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-secondary focus:border-secondary">
                            <input type="text" id="newTag" placeholder="Tag (e.g., @JohnSmithOfficial)" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-secondary focus:border-secondary">
                            <select id="newCategory" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-secondary focus:border-secondary">
                                <option value="DJ">DJ</option>
                                <option value="Venue">Venue</option>
                                <option value="Presenter">Presenter</option>
                                <option value="Artist">Artist</option>
                                <option value="Label">Label</option>
                                <option value="Other">Other</option>
                            </select>
                            <button onclick="addNameMapEntry()" class="w-full py-2 bg-secondary text-white font-bold rounded-lg hover:bg-emerald-600 transition duration-200">
                                Save
                            </button>
                            <p id="addStatus" class="text-xs mt-1"></p>
                        </div>
                        
                         <!-- Bulk Upload (NEW FEATURE) -->
                        <div class="mb-6 p-4 border border-accent/50 rounded-lg bg-accent/10 space-y-3">
                            <h3 class="font-medium text-accent">Bulk Tag Database Import/Export:</h3>
                            <p class="text-xs text-gray-700">Paste your entire tag database (JSON format) below and click Import to overwrite the cloud list.</p>
                            <button onclick="copyInitialInstaMap()" class="px-3 py-1 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-xs">Copy Default Map JSON</button>
                            <textarea id="bulkInstaMapInput" placeholder='{"Name": {"tag": "@handle", "category": "DJ"}, ...}' class="w-full border border-gray-300 rounded-lg p-2 text-xs min-h-[100px]"></textarea>
                            <button onclick="bulkImportTags()" class="w-full py-2 bg-accent text-white font-bold rounded-lg hover:bg-amber-600 transition duration-200">
                                BULK IMPORT TAGS (Overwrite)
                            </button>
                            <p id="bulkStatus" class="text-xs mt-1"></p>
                        </div>

                        <!-- Current List Display -->
                        <h3 class="font-medium text-gray-700 mb-2 mt-6 hidden">Current Entries:</h3>
                        <div class="max-h-96 overflow-y-scroll border border-gray-300 rounded-lg p-3 bg-gray-50">
                            <ul id="databaseList" class="divide-y divide-gray-200">
                                <!-- List items rendered here -->
                            </ul>
                            <p id="emptyListMessage" class="text-center text-gray-500 italic hidden mt-4">No entries found matching your filter/search criteria.</p>
                        </div>
                    </div>
                </div>

                <!-- Default Settings (Col 2/3) -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Global Hashtags -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Global Default Hashtags
                        </h2>
                        <label for="defaultTagsInput" class="block text-sm font-medium text-gray-700 mb-2">
                            Tags added to all events. (Comma-separated)
                        </label>
                        <textarea id="defaultTagsInput" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-accent focus:border-accent transition duration-150" placeholder=""></textarea>
                    </div>

                    <!-- Text Snippets (NEW) -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Reusable Text Snippets
                        </h2>
                         <div class="space-y-3">
                            <select id="snippetSelect" onchange="loadSnippet()" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                                <option value="">--- Load Snippet ---</option>
                            </select>
                            <textarea id="snippetContent" placeholder="" class="w-full border border-gray-300 rounded-lg p-3 text-sm min-h-[180px]"></textarea>
                            <div class="flex space-x-2">
                                <input type="text" id="snippetName" placeholder="Snippet Name" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm">
                                <button onclick="saveSnippet()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">Save</button>
                            </div>
                            <p id="snippetStatus" class="text-xs mt-1"></p>
                        </div>
                    </div>

                    <!-- Event Database (NEW) -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Recurring Event Templates
                        </h2>
                         <div class="space-y-3">
                            <input type="text" id="eventDbName" placeholder="Template Name (e.g., Utopia Festival)" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                             <button onclick="saveEventTemplate()" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-indigo-600 transition text-sm">Save Current Input as Template</button>
                             <div id="eventDbList" class="max-h-32 overflow-y-auto mt-2 p-2 border border-gray-300 rounded-lg bg-gray-50 text-sm">
                                <!-- List of saved templates will appear here -->
                             </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Media Link Management -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Media Source Folder
                        </h2>
                        <label for="mediaFolderLink" class="block text-sm font-medium text-gray-700 mb-2">
                            Google Drive/Cloud Link (Access point for files)
                        </label>
                        <input type="url" id="mediaFolderLink" placeholder="https://drive.google.com/..." class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-secondary focus:border-secondary">
                        <button onclick="saveMediaFolderLink()" class="mt-3 w-full py-2 bg-secondary text-white rounded-lg hover:bg-emerald-600 transition text-sm">
                            Save Folder Link
                        </button>
                        <p id="mediaLinkStatus" class="text-xs mt-1"></p>
                    </div>

                </div>

            </div>
        </div>
        
        <!-- SCHEDULER TAB (NEW) -->
        <div id="tab-scheduler-content" class="tab-content hidden">
             <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                    <svg class="w-7 h-7 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Upcoming Post Schedule
                </h2>
                <div id="scheduledEventsList" class="space-y-4 cursor-grab">
                    <!-- Scheduled events populated here -->
                </div>
                <p id="emptyScheduleMessage" class="text-center text-gray-500 italic mt-8 hidden">No events currently scheduled.</p>
            </div>
        </div>

    </div>

    <script>
        
        // --- GLOBAL CONFIGURATION AND FIREBASE SETUP ---
        var DB_CONFIG = {
            INSTA_DB_KEY: 'nameTagDatabase',
            EVENT_DB_KEY: 'eventDatabase',
            SNIPPETS_KEY: 'textSnippets',
            SCHEDULE_DB_KEY: 'eventSchedule',
            MEDIA_LINK_KEY: 'mediaLink', // New key for the GDrive link
            CATEGORIES: ["DJ", "Venue", "Presenter", "Artist", "Label", "Other"]
        };
        var CATEGORIES = DB_CONFIG.CATEGORIES; 

        // Global Firebase references
        var db = null;
        var auth = null;
        var userId = null;
        var appId = (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
        
        // --- GLOBAL DATA STORES (Updated via Firestore Listeners) ---
        var nameTagDatabase = {}; 
        var eventDatabase = {};   
        var textSnippets = {};    
        var eventSchedule = [];   
        var mediaFolderLink = ''; 


        // --- FIREBASE INITIALIZATION AND DATA LOADING ---

        async function initializeFirebase() {
            if (typeof firebase === 'undefined' || !firebase.initializeApp) {
                console.error("Firebase library not loaded.");
                return;
            }
            
            try {
                // --- START: CUSTOM FIREBASE CONFIGURATION BLOCK ---
                // *** REQUIRED FOR GITHUB PAGES/EXTERNAL DEPLOYMENT ***
                // Your live keys have been pasted here:
                const EXTERNAL_FIREBASE_CONFIG = {
                    apiKey: "AIzaSyBGESFzwqoO9lQivws195udUCo6MXnHeHc", 
                    authDomain: "full-moon-week.firebaseapp.com",
                    projectId: "full-moon-week",
                    storageBucket: "full-moon-week.firebasestorage.app",
                    messagingSenderId: "1064130029135", 
                    appId: "1:1064130029135:web:32b8a8a4414a7ed4036c3a",
                    measurementId: "G-3SS3BJQCRN"
                };
                // --- END: CUSTOM FIREBASE CONFIGURATION BLOCK ---
                
                const configToUse = (typeof __firebase_config !== 'undefined' && __firebase_config.length > 2) 
                    ? JSON.parse(__firebase_config) 
                    : EXTERNAL_FIREBASE_CONFIG;
                    
                if (!configToUse.projectId || configToUse.projectId === "YOUR_PROJECT_ID") {
                    console.error("FIREBASE ERROR: Configuration keys are missing or invalid in code. Please update the EXTERNAL_FIREBASE_CONFIG block.");
                    document.getElementById('statusMessage').textContent = 'CRITICAL ERROR: Firebase config missing. Please paste your keys into the code and re-deploy to GitHub.';
                    document.getElementById('statusMessage').className = 'mt-4 sm:mt-0 text-sm text-red-600 font-bold w-full text-center sm:text-left';
                    return;
                }

                const app = firebase.initializeApp(configToUse);
                auth = firebase.getAuth(app);
                db = firebase.getFirestore(app);

                await authenticateUser();
                await setupListeners();
                
                document.getElementById('statusMessage').textContent = 'Ready to parse. Connected to Cloud Sync.';
                document.getElementById('statusMessage').className = 'mt-4 sm:mt-0 text-sm text-gray-600 w-full text-center sm:text-left';

            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                document.getElementById('statusMessage').textContent = 'ERROR: Firebase failed to connect. Data will not sync.';
                document.getElementById('statusMessage').className = 'mt-4 sm:mt-0 text-sm text-red-600 font-bold w-full text-center sm:text-left';
            }
        }

        async function authenticateUser() {
            return new Promise(async (resolve) => {
                const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                // Use custom token if available (i.e., running in Canvas); otherwise, sign in anonymously (external deployment).
                if (initialToken) {
                    await firebase.signInWithCustomToken(auth, initialToken);
                } else {
                    await firebase.signInAnonymously(auth);
                }

                firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        resolve(true);
                    } else {
                        userId = crypto.randomUUID();
                        resolve(false);
                    }
                });
            });
        }

        function getDocRef(collectionName, docId) {
            if (!db || !userId) throw new Error("Firebase or User not initialized.");
            return firebase.doc(db, `/artifacts/${appId}/users/${userId}/${collectionName}/${docId}`);
        }

        function getInitialInstaMap() {
             return {"2nd Floor Sunset Bar":{"tag":"@2ndfloor.sunsetbar","category":"Venue"},"3MAN":{"tag":"@3man_uk","category":"DJ"},"Aaron Suiss":{"tag":"@aaronsuissofficial","category":"DJ"},"Aatma":{"tag":"@aatmawithin","category":"DJ"},"Abro":{"tag":"@abro.ofc","category":"DJ"},"Acker":{"tag":"@acker_phangan","category":"DJ"},"Acrobat":{"tag":"@acrobat.music","category":"DJ"},"Adi Oren":{"tag":"@_adioren_","category":"DJ"},"Adi Shabat":{"tag":"@adishabat_","category":"DJ"},"AFTERLIFE label":{"tag":"@afterlife_ofc","category":"Label"},"Akshit Shetty":{"tag":"@akshit_shetty","category":"DJ"},"Alan Koh":{"tag":"@alan.island_","category":"DJ"},"Alviker":{"tag":"@alviker","category":"DJ"},"Amiram":{"tag":"@ami_rising_dust","category":"DJ"},"Angelika":{"tag":"@djangelikaofficial","category":"DJ"},"Anna Panilli":{"tag":"@annapanilli","category":"DJ"},"Annabelle":{"tag":"@djparty_kohphangan","category":"DJ"},"Anuyut":{"tag":"@living_things_studio","category":"DJ"},"Apnea":{"tag":"@apneanarchy","category":"DJ"},"Apple Bar, Haad Yao":{"tag":"@applebarhaadyao","category":"Venue"},"Aracil":{"tag":"@aracil_official","category":"DJ"},"Armi":{"tag":"@djarmikp","category":"DJ"},"ArtCore":{"tag":"@ron_levanon_artcore","category":"Artist"},"Artur Snake":{"tag":"@artursnakefilm","category":"DJ"},"Assaf Almog":{"tag":"@dj_assaf_almog","category":"DJ"},"Astrida":{"tag":"@astrida_astridakini","category":"DJ"},"Atman Ananda":{"tag":"@atmanananda_dj","category":"DJ"},"AUM Sound Healing Center":{"tag":"@aumsoundhealing","category":"Venue"},"B.E.M.E.T":{"tag":"@b_e_m_e_t","category":"DJ"},"B14CKPE4R1S":{"tag":"@_b14ckpe4r1s_","category":"DJ"},"B4gle":{"tag":"@b4gle","category":"DJ"},"Back to Donnie":{"tag":"@donniemusic","category":"DJ"},"Bambu":{"tag":"@bambuhuts","category":"Venue"},"Bank Waterfall":{"tag":"@Bank_Waterfall","category":"DJ"},"Barak White":{"tag":"@barakwhite","category":"DJ"},"Bata":{"tag":"@batasamuilover","category":"Artist"},"Bello":{"tag":"@BelloDJ","category":"DJ"},"Berry Linn":{"tag":"@Berry_Linn","category":"DJ"},"Big Splash":{"tag":"@Big_Splash_DnBPresenter","category":"Presenter"},"Black Barrel":{"tag":"@blackbarrel_leocap","category":"DJ"},"Black Venus":{"tag":"@blackvenus__","category":"DJ"},"Bluerama":{"tag":"@bluerama_official","category":"Venue"},"Boyonic":{"tag":"@boyonic7","category":"DJ"},"Brahma":{"tag":"@brahma_music","category":"DJ"},"Bushwacka!":{"tag":"@bushwacka","category":"DJ"},"Cafe 13 Koh Phangan":{"tag":"@cafe13_kohphangan","category":"Venue"},"Cartel De Los Amigos":{"tag":"@carteldelosamigos","category":"Presenter"},"Chill Up":{"tag":"@chill_up_phangan","category":"Venue"},"Chupis":{"tag":"@mr_chupis","category":"DJ"},"Cleo P":{"tag":"@djcleop","category":"DJ"},"Cocoyard":{"tag":"@cocoyard.th","category":"Venue"},"Cosimo Scimo":{"tag":"@cosimoscimo33_45","category":"DJ"},"Cosmic Vibes":{"tag":"@djcosmicvibes","category":"DJ"},"Cosmosis":{"tag":"@cosmosis1","category":"DJ"},"Crealab108":{"tag":"@crealab108_uv_artwork","category":"Artist"},"Culture Club":{"tag":"@cultureclub.kpg","category":"Venue"},"D-Unity":{"tag":"@d_unity","category":"DJ"},"Dalah":{"tag":"@dalahfr","category":"DJ"},"Dani V":{"tag":"@ddjdaniv","category":"DJ"},"Darco":{"tag":"@____darco____","category":"DJ"},"Darin Epsilon":{"tag":"@darinepsilon","category":"DJ"},"Darragh Casey":{"tag":"@darraghcasey","category":"DJ"},"Darwish":{"tag":"@djdarwish","category":"DJ"},"Dava Di Toma":{"tag":"@davaditoma","category":"DJ"},"David Chong":{"tag":"@dj_david_chong","category":"DJ"},"Deborah De Luca":{"tag":"@deborahdeluca","category":"DJ"},"Denium":{"tag":"@hill","category":"DJ"},"Dennis Horvat":{"tag":"@denishorvat","category":"DJ"},"Dennis Lee":{"tag":"@djdennislee","category":"DJ"},"Dennyck":{"tag":"@davidenicolucci","category":"DJ"},"Densoner":{"tag":"@dens_oner","category":"DJ"},"Desert Sail":{"tag":"@desert_sail_music","category":"DJ"},"Dima Odivo":{"tag":"@dima_odivo","category":"DJ"},"Disco Boi":{"tag":"@yigital_","category":"DJ"},"DJ Bishh":{"tag":"@dj.bishh","category":"DJ"},"DJ Danny Dan":{"tag":"@danny_trunprodigital","category":"DJ"},"DJ Darkus":{"tag":"@djdarkus12","category":"DJ"},"DJ Flim":{"tag":"@djflimofficial","category":"DJ"},"DJ Noize":{"tag":"@noizefmp","category":"DJ"},"DJ NOT":{"tag":"@djjj_not","category":"DJ"},"DJ NowAnanda":{"tag":"@nowananda.music","category":"DJ"},"DJ Profile":{"tag":"@djprofileuk","category":"DJ"},"DJ Sith":{"tag":"@djsith555","category":"DJ"},"DJ Yam":{"tag":"@djy.a.m.","category":"DJ"},"DJ Yamagushi":{"tag":"@dj.yamagushi","category":"DJ"},"DJ​xMC Paekingboom":{"tag":"@pae_kingboom","category":"DJ"},"Doc":{"tag":"@doc.moh77","category":"DJ"},"Dovetail":{"tag":"@dovetail.sounds","category":"DJ"},"Dr. Knows":{"tag":"@mr.andidressler","category":"DJ"},"Dragos":{"tag":"@dragos_kpg","category":"DJ"},"Dust":{"tag":"@dustlooneymoon","category":"DJ"},"Dusty Kid":{"tag":"@dustykid_official","category":"DJ"},"Dyslex":{"tag":"@dyslex_phangan","category":"DJ"},"E-Mook":{"tag":"@dj_e.mook","category":"DJ"},"Echo Beach":{"tag":"@echo_beach_hostel","category":"Venue"},"Eden Party":{"tag":"@edengarden_kohphangan","category":"Venue"},"El Gluck":{"tag":"@el.gluck","category":"DJ"},"Electrom":{"tag":"@electromdj","category":"DJ"},"Eli Cicada":{"tag":"@eli.cicada","category":"DJ"},"Erkin Ekici":{"tag":"@erkinekicii","category":"DJ"},"Esterlis":{"tag":"@alex_esterlis","category":"DJ"},"eva180":{"tag":"@eva_brabus_180","category":"DJ"},"Evgeny Sviridov":{"tag":"@evgeny.sviridov_ofc","category":"DJ"},"𝔽𝔸𝔽𝔸 (People on Top)":{"tag":"@fafa.peopleontop","category":"DJ"},"Farid":{"tag":"@farid__ofc","category":"DJ"},"Felon MC":{"tag":"@felonmc","category":"DJ"},"Fred Canal":{"tag":"@fredcanal","category":"DJ"},"Freestylers":{"tag":"@thefreestylersofficial","category":"DJ"},"Funkintao":{"tag":"@vroom.music","category":"DJ"},"Fuziger":{"tag":"@FuzigerDJ","category":"DJ"},"Gadi Schneider":{"tag":"@gadi__schneider","category":"DJ"},"Gana Eden":{"tag":"@gana_eden","category":"DJ"},"Gayatree":{"tag":"@dj_osman_gayatree","category":"DJ"},"Genetica":{"tag":"@genetica_music","category":"DJ"},"Gera Dzhio":{"tag":"@gera_dzhio","category":"DJ"},"Ghost Rider":{"tag":"@ghostrider.music","category":"DJ"},"Gily":{"tag":"@iamgily","category":"DJ"},"Global Flaming":{"tag":"@global_flaming","category":"Artist"},"Golo":{"tag":"@omergolo","category":"DJ"},"Goodman":{"tag":"@GoodmanDJ","category":"DJ"},"Gorovich":{"tag":"@gorovich_official","category":"DJ"},"Graham Gold":{"tag":"@djgrahamgold","category":"DJ"},"Grasshopper Bar":{"tag":"@grasshopperbeachbar","category":"Venue"},"Greg Hilight Tribe":{"tag":"@greghilight","category":"DJ"},"Groovy Tunes":{"tag":"@groovytunes__","category":"Presenter"},"Gunnar Stiller":{"tag":"@gunnarstiller","category":"DJ"},"Guy’s Bar":{"tag":"@guysbarthailand","category":"Venue"},"Guybro":{"tag":"@guyboyangu","category":"DJ"},"Half Moon Festival":{"tag":"@halfmoon.festival","category":"Venue"},"Happy People":{"tag":"@_happy_people_events_","category":"Presenter"},"Harmony Beach Club":{"tag":"@harmonybeachclub","category":"Venue"},"Hioko":{"tag":"@hioko_yo","category":"DJ"},"Hippapa":{"tag":"@real_hippapa","category":"DJ"},"Holice":{"tag":"@holice___","category":"DJ"},"Hollystone":{"tag":"@hollystonephangan","category":"Venue"},"Hooligan":{"tag":"@hooligan_koh_phangan","category":"Venue"},"Hot Stuff":{"tag":"@hot_stuff_phangan","category":"Presenter"},"Hujaboy":{"tag":"@hujaboy","category":"DJ"},"Hybrid UV":{"tag":"@hybriduv","category":"Artist"},"Imagine Mars":{"tag":"@imaginemarsmusic","category":"DJ"},"Infinity Beach Club":{"tag":"@infinitykohphangan","category":"Venue"},"Insomnia Bar":{"tag":"@insomnia_koh_phangan","category":"Venue"},"Islandboy":{"tag":"@islandboy_og","category":"DJ"},"Istina":{"tag":"@djistina_vlubvi","category":"DJ"},"Ivan Croz":{"tag":"@ivancroz","category":"Artist"},"Jaybee":{"tag":"@dnbjaybee","category":"DJ"},"Jo Moontribe":{"tag":"@jomoontribe","category":"DJ"},"Joe Rickard":{"tag":"@joe.rickard.547","category":"DJ"},"Jonny T Fusion":{"tag":"@jonnytribalfusion","category":"DJ"},"Jordan Love":{"tag":"@dj.jordanlove","category":"DJ"},"Juan Verdera":{"tag":"@juanverderafernandez","category":"DJ"},"Julia Kosjakova":{"tag":"@kosjakova","category":"Artist"},"Jungle Experience Festival":{"tag":"@jungleexperiencekohphangan","category":"Venue"},"Kai Vice":{"tag":"@kaivice_music","category":"DJ"},"Kaliko Flow":{"tag":"@kalikoflow","category":"DJ"},"Kasat Ka":{"tag":"@kasatka_dj","category":"DJ"},"Kat":{"tag":"@djkat.music","category":"DJ"},"Kia Goa":{"tag":"@djkia_goa","category":"DJ"},"KIKKAT":{"tag":"@kikkat.music","category":"DJ"},"KINGS CVSTLE":{"tag":"@KingsCvstle","category":"DJ"},"Klang Therapie":{"tag":"@klangtherapie_","category":"DJ"},"Konos":{"tag":"@konosmusic","category":"DJ"},"Konstantin Sibold":{"tag":"@konstantinsibold","category":"DJ"},"Kreis":{"tag":"@thibaut_kreis","category":"DJ"},"Kris Nami":{"tag":"@kris.nami","category":"DJ"},"Kuma":{"tag":"@kuma.musique","category":"DJ"},"Kyzersan":{"tag":"@kyzersan","category":"DJ"},"L'il Chai":{"tag":"@lilchai_16","category":"DJ"},"Laroz":{"tag":"@larozmusic","category":"DJ"},"Lazykay":{"tag":"@l.a.z.y.k.a.y","category":"DJ"},"Le Club Koh Phangan":{"tag":"@leclubkohphangan","category":"Venue"},"Lee Doron":{"tag":"@leedoron15","category":"DJ"},"Leon Mester":{"tag":"@leon_phangan","category":"DJ"},"Libra Libur":{"tag":"@libralibur","category":"DJ"},"Lighthouse Koh Phangan":{"tag":"@lighthousekohphangan","category":"Venue"},"Lirixx":{"tag":"@liriezra5","category":"DJ"},"Los Amigos":{"tag":"@LosAmigosDJ","category":"DJ"},"Lugasi":{"tag":"@_lugasi_","category":"DJ"},"Magic Island":{"tag":"@magicisland_bar","category":"Venue"},"Magit Cacoon":{"tag":"@magitcacoon","category":"DJ"},"Marchelo":{"tag":"@djmarchelo","category":"DJ"},"Marco Loco":{"tag":"@marcolocomusic","category":"DJ"},"Marietty":{"tag":"@MariettyDJ","category":"DJ"},"Mark Bale":{"tag":"@markbale","category":"DJ"},"Markuuz":{"tag":"@markuuz_markuuz","category":"DJ"},"Master Mario":{"tag":"@djmastermario","category":"DJ"},"Matan Rivivi":{"tag":"@matanrevivi","category":"DJ"},"Matt-E":{"tag":"@ergotjames","category":"DJ"},"Medussa Music":{"tag":"@medussamusicth","category":"DJ"},"Merkaba Beach Club, Koh Phangan":{"tag":"@merkabasunset","category":"Venue"},"Mesto":{"tag":"@nashemesto.kohphangan","category":"Venue"},"Minty":{"tag":"@mintybelle","category":"DJ"},"MOBIT":{"tag":"@Mobit.Phangan","category":"DJ"},"Moksha Lane":{"tag":"@moksha_lane","category":"DJ"},"Monkey Space":{"tag":"@monkeyspace_ofc","category":"DJ"},"Mono & the Ocean":{"tag":"@mono_and_the_ocean","category":"DJ"},"Monsteras":{"tag":"@djmonsteras","category":"DJ"},"Moon House":{"tag":"@moon.house.beachbar","category":"Venue"},"Moonrise Beach, Koh Phangan":{"tag":"@moonrisebeach_kohphangan","category":"Venue"},"Mr Z":{"tag":"@zifrmusic","category":"DJ"},"Muhla":{"tag":"@therealmuhla","category":"DJ"},"N1RVAAN":{"tag":"@nirvaanmusic_","category":"DJ"},"Nakadia":{"tag":"@nakadia_music","category":"DJ"},"Nastia":{"tag":"@nastia.dj","category":"DJ"},"Nata":{"tag":"@natarusakovsky","category":"DJ"},"Natralist":{"tag":"@jaynatralist","category":"DJ"},"Nebila Deussal":{"tag":"@nebila_deussal","category":"DJ"},"Nicare":{"tag":"@nicaremusic","category":"DJ"},"Nico Pauly":{"tag":"@nico_pauly","category":"DJ"},"Nicola Calbi":{"tag":"@nicola.calbi","category":"DJ"},"Niiya":{"tag":"@niiyamusica","category":"DJ"},"Nilopeech":{"tag":"@nilopeech_meditation","category":"DJ"},"Nima":{"tag":"@nima_shamarli_","category":"DJ"},"Nisa Brown":{"tag":"@nisa_brown","category":"DJ"},"NO:MAD":{"tag":"@nomad_liveset","category":"DJ"},"Omer Bar":{"tag":"@omerbar_official","category":"DJ"},"OMKA":{"tag":"@omri.m.hay","category":"DJ"},"ØNIZΛL":{"tag":"@onizalart","category":"Artist"},"Oscar L":{"tag":"@oscarldj","category":"DJ"},"Out of Orbit":{"tag":"@outoforbitofficial","category":"DJ"},"Outsiders":{"tag":"@outsiders_music","category":"DJ"},"OXA Beach":{"tag":"@oxapartykohphangan","category":"Venue"},"OXA Party":{"tag":"@oxapartyphangan","category":"Venue"},"P.H.B.":{"tag":"@fabrice.dj.phb","category":"DJ"},"Pash":{"tag":"@dj_pash_dnb","category":"DJ"},"Peacemaker":{"tag":"@dj_peacemaker_","category":"DJ"},"Persistence":{"tag":"@payton_persistence","category":"DJ"},"Peter G":{"tag":"@petergphangan","category":"DJ"},"Playin' Blind":{"tag":"@playinblind","category":"DJ"},"Poe":{"tag":"@dj_poe","category":"DJ"},"Porat":{"tag":"@poratmusic","category":"DJ"},"Porsche":{"tag":"@Porsche_DJ","category":"DJ"},"Pou":{"tag":"@pou_music_ofc","category":"DJ"},"Presti":{"tag":"@presti.__","category":"DJ"},"Primebeat":{"tag":"@primebeat_","category":"DJ"},"Prismatic":{"tag":"@PrismaticDJ","category":"DJ"},"Pyramid":{"tag":"@pyramidkohphangan","category":"Venue"},"Qwent Chang":{"tag":"@qwentchang","category":"DJ"},"R3WIRE":{"tag":"@r3wire","category":"DJ"},"Rasta Home":{"tag":"@RastaHomeKoh","category":"Venue"},"Retro Mountain":{"tag":"@retromountainclubphangan","category":"Venue"},"Retro Mountain Phangan":{"tag":"@retromountainphangan","category":"Venue"},"Ring Of Chain":{"tag":"@_____ringofchain.wav","category":"DJ"},"Rizlablu":{"tag":"@Rizlablu.dnb","category":"DJ"},"Rob Gritton":{"tag":"@robgritton","category":"DJ"},"Roma Dawkins":{"tag":"@roma_dawkins","category":"DJ"},"Ronir":{"tag":"@RonirDJ","category":"DJ"},"Room Service":{"tag":"@room_service_events","category":"Presenter"},"Roymor":{"tag":"@roymor7","category":"DJ"},"Sabaii Bay Beach Club":{"tag":"@sabaiibaybeachclub","category":"Venue"},"Sabrina":{"tag":"@sabrinamadonnacamparifantasie","category":"DJ"},"Sacred Beat":{"tag":"@sacredbeat","category":"DJ"},"Saily":{"tag":"@SailyDJ","category":"DJ"},"Sam Supplier":{"tag":"@samsupplier","category":"DJ"},"Sarina":{"tag":"@sharon_shirr","category":"DJ"},"Sasha Barley":{"tag":"@sasha.barley","category":"DJ"},"Saturn Pub":{"tag":"@saturnpub","category":"Venue"},"Sea Love Beach":{"tag":"@sealovekohphangan","category":"Venue"},"Sean Brauer":{"tag":"@seanbrauerr","category":"DJ"},"SEASIDE Sunset Bar, Koh Phangan":{"tag":"@seaside_sunsetbar_kohphangan","category":"Venue"},"Seebeat":{"tag":"@djseebeat","category":"DJ"},"Selecta G":{"tag":"@selecta_g_aka_damdam","category":"DJ"},"Selecta Snoop":{"tag":"@selecta_snoop","category":"DJ"},"SHALØS":{"tag":"@shalos__","category":"DJ"},"Sharnea":{"tag":"@sharnea_xo","category":"DJ"},"Shayman":{"tag":"@shayman.official","category":"DJ"},"Sho Sho":{"tag":"@shoshojp","category":"DJ"},"Simon Kruger":{"tag":"@SimonKrugerDJ","category":"DJ"},"Slacky":{"tag":"@___slacky","category":"DJ"},"SNGI":{"tag":"@sngi_alex","category":"DJ"},"Sola":{"tag":"@SolaDJ","category":"DJ"},"Solar Conexion":{"tag":"@solar_conexion","category":"Presenter"},"Somatic Cell":{"tag":"@somatic_cell","category":"DJ"},"Sophie States":{"tag":"@sophiestates_","category":"DJ"},"Space Club Haad Rin":{"tag":"@spaceclub_haadrin","category":"Venue"},"Sphera":{"tag":"@_sphera","category":"DJ"},"Sramanora Bar":{"tag":"@sramanorabar","category":"Venue"},"Stay Gold":{"tag":"@staygold.phangan","category":"DJ"},"Stevie Keys":{"tag":"@djsteviekeys","category":"DJ"},"Sun Diary":{"tag":"@sun_diary_music","category":"DJ"},"Sunset Hill Resort":{"tag":"@sunsethillresort","category":"Venue"},"Suzy Lynx":{"tag":"@SuzyLynx","category":"DJ"},"Swarup":{"tag":"@juarezpetrillo","category":"DJ"},"Syd Gris":{"tag":"@syd_gris","category":"DJ"},"T-Gecko":{"tag":"@t_gecko_music","category":"DJ"},"Talamasca":{"tag":"@talamasca_official","category":"DJ"},"Taz Jacks":{"tag":"@taz_jacks","category":"DJ"},"TEE-O":{"tag":"@theocid_","category":"DJ"},"Telomancer":{"tag":"@telomancer_music","category":"DJ"},"Tezla":{"tag":"@tezla_music","category":"DJ"},"The Element":{"tag":"@theelement____","category":"DJ"},"The Grounds at Siam Cookies Koh Phangan":{"tag":"@thegroundsxsiamcookies","category":"Venue"},"The Wave​ Sunset​":{"tag":"@thewave_sunset","category":"Venue"},"The Wild Side":{"tag":"@thewildside_kohphangan","category":"Venue"},"Timo":{"tag":"@dj.timo.official","category":"DJ"},"Tino Moreno":{"tag":"@tinomoreno77","category":"DJ"},"Tintun":{"tag":"@tintun.tunes","category":"DJ"},"Traumgeist":{"tag":"@traumgeist_dnb","category":"DJ"},"Tripical Note":{"tag":"@tripicalnote_ofc","category":"DJ"},"Tutu":{"tag":"@tom_barnea","category":"DJ"},"Tzvi Sharf":{"tag":"@tzvi.sharf","category":"DJ"},"Unclave":{"tag":"@unclave.phangan","category":"Venue"},"Up to J":{"tag":"@UpToJDJ","category":"DJ"},"UTOPIA Festival":{"tag":"@utopia.events.pro","category":"Venue"},"Vakabular":{"tag":"@djvakabular","category":"DJ"},"Vegas":{"tag":"@vegaslive","category":"DJ"},"Victor Oneoff":{"tag":"@victor_kohphangan","category":"DJ"},"Violyricals":{"tag":"@Violyricals","category":"Artist"},"Waqt":{"tag":"@djchinx_cluster_waqt","category":"DJ"},"Waterfall Festival":{"tag":"@waterfall_festival_official","category":"Venue"},"Waterfall Festival Phangan":{"tag":"@waterfallfestivalphangan","category":"Venue"},"WET Hostel":{"tag":"@wethostel","category":"Venue"},"WET Pool Party":{"tag":"@WETPoolParty","category":"Venue"},"Woodsy":{"tag":"@woodsy.dnb","category":"DJ"},"Yam":{"tag":"@yam.freedom.dj","category":"DJ"},"Yam (Violyricals)":{"tag":"@djy.a.m","category":"DJ"},"Yekumi":{"tag":"@yekumi","category":"DJ"},"YEP Listening Bar":{"tag":"@yep_listening_bar","category":"Venue"},"Yo Logo":{"tag":"@johann.ilpide","category":"DJ"},"Yodafestedelik":{"tag":"@yodafestedelik","category":"DJ"},"Yolozen":{"tag":"@_yolozen","category":"DJ"},"Yugo":{"tag":"@yugo_the_dj","category":"DJ"},"Zeeqar":{"tag":"@zeeqar_","category":"DJ"},"Zero 1 Music":{"tag":"@zero1music","category":"Label"},"Zifr":{"tag":"@zifrmusic","category":"DJ"},"Zig":{"tag":"@d.j.zig","category":"DJ"},"Zoe Azad":{"tag":"@zoeazad","category":"DJ"},"Machet":{"tag":"@nadavmachet","category":"DJ"},"Kudo":{"tag":"@kudo__official","category":"DJ"},"Dano":{"tag":"@DanoYashar","category":"DJ"},"Yashar":{"tag":"@YasharVahid","category":"DJ"},"Vahid":{"tag":"@vahidsadeghzadeh","category":"DJ"},"Ban Sabaii":{"tag":"@ban.sabaii","category":"Venue"},"Jascio":{"tag":"@jascio888","category":"DJ"},"Vincent Vino":{"tag":"@doodleswithvino","category":"Artist"},"Carlton":{"tag":"@carltonthomas90","category":"DJ"},"Matthew":{"tag":"@MatthewMagnus","category":"DJ"},"Magnus":{"tag":"@MagnusFactor50","category":"DJ"},"Factor 50":{"tag":"@Factor50Basner","category":"DJ"},"Basner":{"tag":"@BasnerMae","category":"DJ"},"Mae":{"tag":"@MaeGrooveOne","category":"DJ"},"GrooveOne Agency":{"tag":"@grooveoneagency","category":"Presenter"},"Hole Station":{"tag":"@holestation","category":"Venue"},"Dagda":{"tag":"@djdagda","category":"DJ"},"thenotsofamous":{"tag":"@thenotsofamous","category":"DJ"},"Ankytrixx":{"tag":"@ankytrixx","category":"DJ"},"Damien Nëmad":{"tag":"@damiennemad","category":"DJ"},"Ayavi":{"tag":"@ayavi.kandoo","category":"DJ"}};
        }

        // --- UTILITY FUNCTIONS ---
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                return true;
            } catch (err) {
                console.error('Copy failed:', err);
                return false;
            } finally {
                document.body.removeChild(textarea);
            }
        }
        
        function dateDifference(date1, date2) {
            const ONE_DAY = 1000 * 60 * 60 * 24;
            const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());

            return Math.floor((utc2 - utc1) / ONE_DAY);
        }

        function formatDateFriendly(isoDate) {
            if (!isoDate) return 'TBD Date';
            try {
                const date = new Date(isoDate + 'T00:00:00'); 
                const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            } catch (e) {
                console.error("Error formatting date:", e);
                return isoDate;
            }
        }

        /**
         * Generates suggested file name (DDMMM - LOCATION)
         */
        function generateFileName() {
            const isoDate = document.getElementById('inputIsoDate').value.trim();
            const location = document.getElementById('inputLocation').value.trim();
            const outputEl = document.getElementById('fileNameOutput');

            if (!isoDate || !location) {
                outputEl.textContent = 'Please enter Date and Location.';
                outputEl.className = 'text-red-500 text-xs mt-2';
                return '';
            }

            try {
                const date = new Date(isoDate + 'T00:00:00');
                const day = date.getDate().toString().padStart(2, '0');
                const month = date.toLocaleString('en-US', { month: 'short' }).toUpperCase();
                
                let cleanedLocation = location
                    .replace(/[^a-zA-Z0-9\s]/g, '')
                    .replace(/\s+/g, '_')          
                    .trim();

                const fileInput = document.getElementById('mediaUpload');
                let ext = '.jpg/mp4'; 
                if (fileInput.files.length > 0) {
                    const fileName = fileInput.files[0].name;
                    const dotIndex = fileName.lastIndexOf('.');
                    if (dotIndex !== -1) {
                        ext = fileName.substring(dotIndex);
                    } else {
                        ext = '';
                    }
                }
                
                const newFileName = `${day}${month}-${cleanedLocation}${ext}`;
                outputEl.textContent = `${newFileName}`;
                outputEl.className = 'text-gray-700 text-xs mt-2 break-all font-mono';
                copyToClipboard(newFileName);
                
                return newFileName;

            } catch (e) {
                outputEl.textContent = 'Error generating filename.';
                outputEl.className = 'text-red-500 text-xs mt-2';
                console.error("File name generation error:", e);
                return '';
            }
        }


        // --- DATA MANAGEMENT: FIREBASE ---

        async function saveDataToFirestore(collectionName, data) {
            if (!db || !userId) {
                console.error("Database not ready. Saving locally.");
                // Fallback to local storage for testing if Firebase fails
                // (Note: This local fallback is ONLY for dev/testing, removed in final version)
                return;
            }

            try {
                const docRef = getDocRef(collectionName, 'main'); // Using 'main' as the fixed document ID
                
                // For the schedule, we save the array directly under the fixed ID
                if (collectionName === DB_CONFIG.SCHEDULE_DB_KEY) {
                     await firebase.setDoc(docRef, { events: data, lastUpdated: new Date().toISOString() });
                } else {
                    // For map-based data (tags, snippets, templates)
                    await firebase.setDoc(docRef, data);
                }
                
            } catch (e) {
                console.error(`Error saving ${collectionName} to Firestore:`, e);
            }
        }

        async function setupListeners() {
            if (!db || !userId) return;

            const collections = [
                { name: DB_CONFIG.INSTA_DB_KEY, target: nameTagDatabase, defaultData: getInitialInstaMap(), render: renderNameMap },
                { name: DB_CONFIG.EVENT_DB_KEY, target: eventDatabase, defaultData: {}, render: renderEventTemplateSelect },
                { name: DB_CONFIG.SNIPPETS_KEY, target: textSnippets, defaultData: {}, render: renderSnippetSelect },
                { name: DB_CONFIG.SCHEDULE_DB_KEY, target: eventSchedule, defaultData: [], render: renderScheduleList },
                { name: DB_CONFIG.MEDIA_LINK_KEY, target: mediaFolderLink, defaultData: '', render: renderMediaLink } // New Listener for Media Link
            ];

            collections.forEach(({ name, target, defaultData, render }) => {
                const docRef = getDocRef(name, 'main');
                
                firebase.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // Handle Media Link (single string)
                        if (name === DB_CONFIG.MEDIA_LINK_KEY) {
                            window.mediaFolderLink = data.link || '';
                        }
                        
                        // Clear and update global store
                        if (Array.isArray(target)) {
                            target.splice(0, target.length, ...(name === DB_CONFIG.SCHEDULE_DB_KEY ? data.events || [] : []));
                        } else {
                            for (const prop in target) { delete target[prop]; }
                            Object.assign(target, (name === DB_CONFIG.SCHEDULE_DB_KEY ? data.events || {} : data));
                        }
                    } else if (Object.keys(defaultData).length > 0 || Array.isArray(defaultData)) {
                        // Document doesn't exist, set initial data
                        if (name === DB_CONFIG.SCHEDULE_DB_KEY) {
                            saveDataToFirestore(name, defaultData);
                        } else {
                            saveDataToFirestore(name, defaultData);
                        }
                    }
                    render();
                }, (error) => {
                    console.error(`Error listening to ${name}:`, error);
                });
            });
        }


        // --- UI CONTROL ---
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabName}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}-btn`).classList.add('active');
            
            // Special initialization for the Scheduler tab
            if (tabName === 'scheduler') {
                renderScheduleList();
                initializeSortable(); // Initialize drag-and-drop
            } else if (tabName === 'settings') {
                document.getElementById('mediaFolderLink').value = mediaFolderLink;
            }
        }


        // --- DATA MANAGEMENT: NAME-TAG DB (2a) ---

        function copyInitialInstaMap() {
            const mapJson = JSON.stringify(getInitialInstaMap(), null, 2);
            copyToClipboard(mapJson);
            document.getElementById('bulkStatus').textContent = 'Default map copied to clipboard. Paste into the box above.';
            document.getElementById('bulkStatus').className = 'text-xs mt-1 text-secondary';
        }

        async function bulkImportTags() {
            const jsonStr = document.getElementById('bulkInstaMapInput').value.trim();
            const statusEl = document.getElementById('bulkStatus');
            
            statusEl.className = 'text-xs mt-1 text-red-600';

            if (!jsonStr) {
                statusEl.textContent = 'Error: Paste JSON data before importing.';
                return;
            }

            try {
                const importedData = JSON.parse(jsonStr);
                
                // Simple validation: ensure it's an object of objects/tags
                if (typeof importedData !== 'object' || Array.isArray(importedData)) {
                    throw new Error("Invalid format. Must be a JSON object like: {\"Name\": {\"tag\": \"@handle\", ...}}");
                }
                
                // Clear current local map and load new data
                for (const prop in nameTagDatabase) { delete nameTagDatabase[prop]; }
                Object.assign(nameTagDatabase, importedData);
                
                // Save to Firestore (overwriting the cloud data)
                await saveDataToFirestore(DB_CONFIG.INSTA_DB_KEY, nameTagDatabase);
                
                // Clear input field
                document.getElementById('bulkInstaMapInput').value = '';

                statusEl.className = 'text-xs mt-1 text-secondary';
                statusEl.textContent = `Success! Imported ${Object.keys(nameTagDatabase).length} tags and saved to cloud.`;
                
            } catch (e) {
                statusEl.textContent = `Import Error: ${e.message}`;
            }
        }

        function renderNameMap() {
            const listEl = document.getElementById('databaseList');
            const searchVal = document.getElementById('nameSearch').value.toLowerCase();
            const filterCat = document.getElementById('categoryFilter').value;
            listEl.innerHTML = '';
            
            const entries = Object.entries(nameTagDatabase).map(([name, data]) => ({
                name: name,
                tag: data.tag,
                category: data.category || 'Other'
            }));
            
            const filteredEntries = entries.filter(entry => {
                const nameMatch = entry.name.toLowerCase().includes(searchVal) || entry.tag.toLowerCase().includes(searchVal);
                const categoryMatch = !filterCat || entry.category === filterCat;
                return nameMatch && categoryMatch;
            });

            filteredEntries.sort((a, b) => a.name.localeCompare(b.name));

            filteredEntries.forEach(({ name, tag, category }) => {
                const li = document.createElement('li');
                li.className = 'compact-list-item flex justify-between items-center text-xs'; 
                li.innerHTML = `
                    <div class="flex-1 min-w-0 pr-1 truncate">
                        <span class="font-medium text-gray-900 block truncate">${name}</span> 
                        <span class="text-secondary inline">${tag}</span>
                        <span class="text-gray-500 text-xs ml-2">(${category})</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button onclick="copyToClipboard('${tag}')" class="text-primary hover:text-indigo-600 p-1 rounded hover:bg-indigo-50 transition" title="Copy Tag">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2"></path></svg>
                        </button>
                        <button data-name="${name}" onclick="removeNameMapEntry(this)" class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition" title="Remove Entry">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                listEl.appendChild(li);
            });
            
            document.getElementById('emptyListMessage').classList.toggle('hidden', filteredEntries.length > 0);
        }

        async function addNameMapEntry() {
            const name = document.getElementById('newName').value.trim();
            let tag = document.getElementById('newTag').value.trim();
            const category = document.getElementById('newCategory').value; 
            const statusEl = document.getElementById('addStatus');
            
            statusEl.className = 'text-xs mt-1 text-red-600';

            if (!name || !tag) {
                statusEl.textContent = 'Error: Name and Tag are required.';
                return;
            }

            if (!tag.startsWith('@') && !tag.startsWith('#')) {
                tag = '@' + tag;
            }

            if (nameTagDatabase[name]) {
                statusEl.textContent = `Error: "${name}" already exists.`;
                return;
            }

            nameTagDatabase[name] = { tag: tag, category: category }; 

            document.getElementById('newName').value = '';
            document.getElementById('newTag').value = '';
            
            await saveDataToFirestore(DB_CONFIG.INSTA_DB_KEY, nameTagDatabase);
            statusEl.className = 'text-xs mt-1 text-secondary';
            statusEl.textContent = `Success: "${name}" saved.`;
        }

        async function removeNameMapEntry(button) {
            const nameToRemove = button.getAttribute('data-name');
            if (!confirm(`Are you sure you want to delete ${nameToRemove}?`)) return;

            delete nameTagDatabase[nameToRemove];
            await saveDataToFirestore(DB_CONFIG.INSTA_DB_KEY, nameTagDatabase);
        }


        // --- DATA MANAGEMENT: SCHEDULER (DRAG-N-DROP & FIREBASE) ---

        function initializeSortable() {
            const list = document.getElementById('scheduledEventsList');
            if (Sortable.get(list)) {
                Sortable.get(list).destroy();
            }

            new Sortable(list, {
                animation: 150,
                ghostClass: 'sortable-drag',
                onEnd: async function (evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    // 1. Get the items based on the current display order (which is eventSchedule)
                    const [movedItem] = eventSchedule.splice(oldIndex, 1);
                    eventSchedule.splice(newIndex, 0, movedItem);
                    
                    // 2. Save the new order to Firestore
                    await saveDataToFirestore(DB_CONFIG.SCHEDULE_DB_KEY, eventSchedule);
                    // No need to call renderScheduleList(), Firestore listener handles it
                },
            });
        }


        function renderScheduleList() {
            const listEl = document.getElementById('scheduledEventsList');
            listEl.innerHTML = '';

            if (eventSchedule.length === 0) {
                document.getElementById('emptyScheduleMessage').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyScheduleMessage').classList.add('hidden');

            // Find the earliest date among all scheduled events to calculate Day 1
            const dates = eventSchedule.map(e => new Date(e.date));
            const minDate = dates.reduce((min, current) => current < min ? current : min, dates[0]);
            const dayOneDate = minDate ? new Date(minDate.toISOString().split('T')[0]) : null;

            // Iterate through the array (which is now in the desired display order)
            eventSchedule.forEach((event, index) => {
                const eventDate = new Date(event.date);
                const dayNumber = dayOneDate ? dateDifference(dayOneDate, eventDate) + 1 : 'X';
                
                // Apply the dynamic Day [x] prefix when rendering
                const dayPrefix = `🌕Full Moon Week - Day ${dayNumber}🌕\n`;
                const finalPostText = dayPrefix + event.postText;
                
                const mediaFileName = event.mediaFileName || 'N/A';
                
                // FIX: Make the filename a clickable link to the media folder
                let mediaLinkHtml = mediaFileName;
                if (window.mediaFolderLink && window.mediaFolderLink !== '') {
                    mediaLinkHtml = `<a href="${window.mediaFolderLink}" target="_blank" class="text-blue-600 underline hover:text-blue-800 break-all">${mediaFileName}</a>`;
                }


                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-lg bg-white shadow-sm space-y-3 cursor-grab';
                div.setAttribute('data-id', event.date + event.eventName); // Identifier for Sortable
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-bold text-primary">${event.eventName} <span class="text-gray-500 font-medium ml-2 text-sm">| Day ${dayNumber}</span></h3>
                        <div class="flex space-x-2">
                            <button onclick="copyToClipboard(document.getElementById('post-text-${index}').value)" class="text-sm px-3 py-1 bg-primary text-white rounded-full hover:bg-indigo-600 transition">Copy Post</button>
                            <button onclick="copyToClipboard(document.getElementById('tags-only-${index}').value)" class="text-sm px-3 py-1 bg-secondary text-white rounded-full hover:bg-emerald-600 transition">Copy Tags</button>
                            <button onclick="removeScheduledEvent(${index})" class="text-red-500 hover:text-red-700 p-1 transition" title="Delete Event">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-700">🗓 Date: ${event.inputDateFriendly}</p>
                    
                    <div class="flex items-center space-x-2 bg-gray-100 p-2 rounded border border-dashed">
                        <span class="text-xs font-semibold text-gray-900">Media File:</span>
                        <span class="text-xs font-mono text-gray-700 break-all">${mediaLinkHtml}</span>
                        <button onclick="copyToClipboard('${mediaFileName}')" class="text-xs text-primary hover:text-indigo-600" title="Copy Filename">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2"></path></svg>
                        </button>
                    </div>

                    <label class="block text-sm font-medium text-gray-700">Post Text:</label>
                    <textarea id="post-text-${index}" class="w-full border rounded-lg p-2 text-sm bg-white" rows="6" readonly>${finalPostText}</textarea>
                    
                    <label class="block text-sm font-medium text-gray-700">Story Tags:</label>
                    <textarea id="tags-only-${index}" class="w-full border rounded-lg p-2 text-sm bg-white" rows="4" readonly>${event.tagsOnly}</textarea>
                `;
                listEl.appendChild(div);
            });
        }

        async function removeScheduledEvent(index) {
            if (confirm("Are you sure you want to delete this scheduled event?")) {
                eventSchedule.splice(index, 1);
                await saveDataToFirestore(DB_CONFIG.SCHEDULE_DB_KEY, eventSchedule);
            }
        }


        // --- DATA MANAGEMENT: SNIPPETS & TEMPLATES ---
        
        function renderSnippetSelect() {
            const selectEl = document.getElementById('snippetSelect');
            selectEl.innerHTML = '<option value="">--- Load Snippet ---</option>';
            const names = Object.keys(textSnippets).sort();
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selectEl.appendChild(option);
            });
        }

        function loadSnippet() {
            const name = document.getElementById('snippetSelect').value;
            const contentEl = document.getElementById('snippetContent');
            const nameInputEl = document.getElementById('snippetName');
            
            if (name && textSnippets[name]) {
                contentEl.value = textSnippets[name];
                nameInputEl.value = name;
            } else {
                contentEl.value = '';
                nameInputEl.value = '';
            }
        }

        async function saveSnippet() {
            const name = document.getElementById('snippetName').value.trim();
            const content = document.getElementById('snippetContent').value.trim();
            const statusEl = document.getElementById('snippetStatus');

            if (!name || !content) {
                statusEl.textContent = 'Name and content are required.';
                statusEl.className = 'text-xs mt-1 text-red-600';
                return;
            }

            textSnippets[name] = content;
            await saveDataToFirestore(DB_CONFIG.SNIPPETS_KEY, textSnippets);
            statusEl.textContent = `Snippet "${name}" saved!`;
            statusEl.className = 'text-xs mt-1 text-secondary';
        }
        
        function renderEventTemplateSelect() {
            const selectEl = document.getElementById('eventTemplateSelect');
            const listEl = document.getElementById('eventDbList');
            selectEl.innerHTML = '<option value="">--- Select Event Template ---</option>';
            listEl.innerHTML = '';

            const names = Object.keys(eventDatabase).sort();
            
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selectEl.appendChild(option);

                const div = document.createElement('div');
                div.className = 'flex justify-between items-center py-1';
                div.innerHTML = `
                    <span class="text-gray-800">${name}</span>
                    <button data-name="${name}" onclick="removeEventTemplate(this)" class="text-red-500 hover:text-red-700 ml-4 text-xs">Remove</button>
                `;
                listEl.appendChild(div);
            });
        }

        async function saveEventTemplate() {
            const name = document.getElementById('eventDbName').value.trim();
            const location = document.getElementById('inputLocation').value.trim();
            const hashtags = document.getElementById('defaultTagsInput').value.trim();
            const description = document.getElementById('rawDescription').value.trim();

            if (!name || !location) {
                alert("Please enter a Template Name and Location to save the template.");
                return;
            }

            eventDatabase[name] = {
                location: location,
                hashtags: hashtags,
                description: description
            };

            document.getElementById('eventDbName').value = '';
            await saveDataToFirestore(DB_CONFIG.EVENT_DB_KEY, eventDatabase);
            alert(`Template "${name}" saved!`);
        }

        function loadEventTemplate() {
            const name = document.getElementById('eventTemplateSelect').value;
            if (name && eventDatabase[name]) {
                const template = eventDatabase[name];
                
                document.getElementById('inputIsoDate').value = ""; 
                document.getElementById('inputEventName').value = name;
                document.getElementById('inputLocation').value = template.location;
                document.getElementById('defaultTagsInput').value = template.hashtags;
                document.getElementById('rawDescription').value = template.description;

                document.getElementById('statusMessage').textContent = `Template "${name}" loaded.`;
                document.getElementById('statusMessage').className = 'mt-4 sm:mt-0 text-sm text-primary font-bold w-full text-center sm:text-left';
            }
        }

        async function removeEventTemplate(button) {
            const nameToRemove = button.getAttribute('data-name');
            if(confirm(`Are you sure you want to remove template "${nameToRemove}"?`)) {
                delete eventDatabase[nameToRemove];
                await saveDataToFirestore(DB_CONFIG.EVENT_DB_KEY, eventDatabase);
            }
        }
        
        function renderMediaLink() {
            document.getElementById('mediaFolderLink').value = mediaFolderLink;
        }
        
        async function saveMediaFolderLink() {
            const link = document.getElementById('mediaFolderLink').value.trim();
            const statusEl = document.getElementById('mediaLinkStatus');
            
            if (!link || !link.startsWith('http')) {
                statusEl.textContent = 'Please enter a valid link.';
                statusEl.className = 'text-xs mt-1 text-red-600';
                return;
            }
            
            window.mediaFolderLink = link;
            await saveDataToFirestore(DB_CONFIG.MEDIA_LINK_KEY, { link: link });
            
            statusEl.textContent = 'Media folder link saved!';
            statusEl.className = 'text-xs mt-1 text-secondary';
        }


        // --- CORE PARSING LOGIC (FINALIZED) ---

        function processStructuredEvent(structuredData, description, extraHashtags, instaMap, defaultHashtags) {
            
            let allTagsWithOrder = []; 
            let tagsToInject = {}; 
            const block = description; 
            
            // 1. Extract existing tags from description and record their index (order)
            const tagMatches = Array.from(block.matchAll(/@(\w+\.?\w+)/g));
            
            tagMatches.forEach(match => {
                const tag = match[0].toLowerCase();
                if (!allTagsWithOrder.some(item => item.tag === tag)) {
                    allTagsWithOrder.push({ tag: tag, index: match.index });
                }
            });

            // 2. Search database (instaMap) for names and prepare insertion map
            
            for (const name in instaMap) {
                const tagData = instaMap[name];
                const tag = tagData.tag.toLowerCase();
                
                const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const nameRegex = new RegExp(`\\b${escapedName}\\b`, 'gi');
                
                const searchMatches = Array.from(block.matchAll(nameRegex));
                
                if (searchMatches.length > 0) {
                    
                    // a) For 3b ordering: collect all unique tags found (using the first occurrence index)
                    if (!allTagsWithOrder.some(item => item.tag === tag)) {
                        allTagsWithOrder.push({ tag: tag, index: searchMatches[0].index }); 
                    }
                    
                    // b) For 3a injection: store {Name: "@handle"}
                    // Check if the name is already followed by the tag (or any @-tag)
                    const injectionCheckRegex = new RegExp(`\\b${escapedName}\\s*@\\w+\\b`, 'i');
                    if (!block.match(injectionCheckRegex)) {
                        tagsToInject[name] = tagData.tag; // Store original casing of the tag
                    }
                }
            }
            
            // --- Inject tags into the description for 3a output ---
            let postDescription = description;
            
            const sortedNames = Object.keys(tagsToInject).sort((a, b) => b.length - a.length);

            sortedNames.forEach(name => {
                const tagToInject = tagsToInject[name];
                
                // FIX: This simplified injection regex is robust across browsers.
                const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                // Regex: Find the whole word (name) that IS NOT followed by an @-tag. (The pre-check should handle the not-followed part, but this ensures a clean match.)
                const injectionRegex = new RegExp(`(\\b${escapedName}\\b)`, 'g');
                
                // Use $1 to preserve casing in the text.
                postDescription = postDescription.replace(injectionRegex, `$1 ${tagToInject}`);
            });

            
            // 3. Final Tag Consolidation and Ordering (3b)

            const extraTagsArray = extraHashtags.split(',').map(t => `#${t.trim().replace(/^#/, '').toLowerCase()}`).filter(t => t.length > 1);
            const finalHashtags = [...defaultHashtags.map(t => `#${t.toLowerCase()}`), ...extraTagsArray];
            
            // FIX: Guarantee order of appearance for 3b output
            allTagsWithOrder.sort((a, b) => a.index - b.index);
            
            const orderedInstaTags = [];
            const seenTags = new Set();
            allTagsWithOrder.forEach(item => {
                if (item.tag.startsWith('@') && !seenTags.has(item.tag)) {
                    orderedInstaTags.push(item.tag);
                    seenTags.add(item.tag);
                }
            });
            
            // 4. Standardized Output Generation (3a)
            const hashtagsOutput = finalHashtags.filter(tag => tag.startsWith('#')).join(' ');

            const dateFriendly = formatDateFriendly(structuredData.isoDate);

            // Output includes placeholder Day X prefix
            const basePostText = 
                `🗓 DATE: ${dateFriendly}\n` + 
                `🎉 EVENT: ${structuredData.eventName}\n` + 
                `📍 LOCATION: ${structuredData.location}\n` + 
                `\n` +
                postDescription.trim() + 
                `\n\n` +
                `${hashtagsOutput}`;

            return {
                postText: basePostText,
                tagsOnly: orderedInstaTags.join('\n'), 
            };
        }


        // --- MAIN HANDLER ---

        async function handleClick(saveToSchedule) {
            const structuredData = {
                isoDate: document.getElementById('inputIsoDate').value.trim(),
                eventName: document.getElementById('inputEventName').value.trim(),
                location: document.getElementById('inputLocation').value.trim(),
            };
            
            const dateFriendly = formatDateFriendly(structuredData.isoDate);
            const mediaFileName = generateFileName(); // Updates the UI output as well
            const description = document.getElementById('rawDescription').value;
            const defaultTagsStr = document.getElementById('defaultTagsInput').value;
            const extraHashtags = document.getElementById('extraHashtagsInput').value;
            const statusMessage = document.getElementById('statusMessage');

            statusMessage.textContent = 'Processing...';

            const defaultHashtags = defaultTagsStr
                .split(',')
                .map(tag => tag.trim().replace(/^#/, ''))
                .filter(tag => tag.length > 0);

            if (!structuredData.isoDate || !structuredData.eventName || !description.trim()) {
                 statusMessage.className = 'mt-4 sm:mt-0 text-sm text-red-600 font-bold w-full text-center sm:text-left';
                 statusMessage.textContent = 'Error: Date, Event Name, and Description are required fields.';
                 return;
            }

            try {
                const result = processStructuredEvent(structuredData, description, extraHashtags, nameTagDatabase, defaultHashtags);
                
                let finalPostTextWithPlaceholder = `🌕Full Moon Week - Day X🌕\n${result.postText}`;

                if (saveToSchedule) {
                    const finalPostTextForSave = document.getElementById('calendarOutput').value.trim();

                    eventSchedule.push({
                        eventName: structuredData.eventName,
                        date: structuredData.isoDate,
                        inputDateFriendly: dateFriendly,
                        postText: finalPostTextForSave.replace(/🌕Full Moon Week - Day X🌕\n/, ''),
                        tagsOnly: document.getElementById('tagsOnlyOutput').value,
                        mediaFileName: mediaFileName 
                    });
                    
                    await saveDataToFirestore(DB_CONFIG.SCHEDULE_DB_KEY, eventSchedule);
                    
                    statusMessage.className = 'mt-4 sm:mt-0 text-sm text-accent font-bold w-full text-center sm:text-left';
                    statusMessage.textContent = `Event "${structuredData.eventName}" saved to Scheduler!`;
                    showTab('scheduler');
                } else {
                    document.getElementById('calendarOutput').value = finalPostTextWithPlaceholder;
                    document.getElementById('tagsOnlyOutput').value = result.tagsOnly;
                    
                    statusMessage.className = 'mt-4 sm:mt-0 text-sm text-secondary font-bold w-full text-center sm:text-left';
                    statusMessage.textContent = 'Parsing Complete! Click to Save';
                }

            } catch (e) {
                console.error(e);
                statusMessage.className = 'mt-4 sm:mt-0 text-sm text-red-600 font-bold w-full text-center sm:text-left';
                statusMessage.textContent = `Critical Error: ${e.message}. Check console.`;
            }
        }


        // --- INITIALIZATION ---
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            
            // --- Input Field Defaults ---
            document.getElementById('inputEventName').value = "";
            document.getElementById('inputLocation').value = "";
            document.getElementById('rawDescription').value = "";
            document.getElementById('extraHashtagsInput').value = "";
            document.getElementById('defaultTagsInput').value = "fullmoonweek, fullmoonparty, kohphangan, thailand, parties, fullmoonpartykohphangan";
        });
        
    </script>
</body>
</html>
