<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Moon Posting Scheduler</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5', /* Indigo */
                        'secondary': '#10b981', /* Emerald */
                        'background': '#f9fafb',
                        'accent': '#f59e0b', /* Amber */
                        'danger': '#ef4444', /* Red */
                    },
                      screens: {
                        'sm': '640px',
                        'md': '768px',
                        // CUSTOM BREAKPOINT: Only collapse to 1 column below 768px
                        'lg': '992px', 
                        'xl': '1280px',
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better textarea visibility */
        textarea {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5;
            resize: vertical;
        }
        #rawDescription {
            min-height: 200px; /* Adjusted for compactness */
        }
        #calendarOutput {
            min-height: 250px;
        }
        #tagsOnlyOutput {
            min-height: 150px; /* Increased height for 3b */
        }
        #defaultTagsInput {
            font-size: 0.8rem; /* Smaller font for global hashtags */
        }
        /* FIX: Active tab highlight with RED text AND explicit BG color */
        .tab-button.active {
            border-bottom: 4px solid #ef4444 !important; /* Red */
            color: #ef4444 !important; /* Red */
            font-weight: 600 !important;
            background-color: #f1f5f9 !important; /* light gray for contrast */
        }
        /* Aggressively compacting the list items in settings */
        .compact-list-item {
            padding-top: 0.15rem; /* Further reduced padding */
            padding-bottom: 0.15rem;
            font-size: 0.75rem; /* text-xs for list content */
        }
        .compact-list-item span {
            font-size: 0.75rem;
        }
        /* Specific width for date picker */
        .date-input-container input[type="date"] {
            width: 150px; 
            max-width: 150px;
        }
        .sortable-drag {
            opacity: 0.6;
            background-color: #f1f5f9; /* Blue-gray for drag visual feedback */
        }
        /* FIX: Settings column structure - Using fixed grid definition for 30/70 split, only collapsing below 768px */
        .settings-grid-container-custom {
            display: grid;
            grid-template-columns: 30% 70%;
            gap: 2rem; 
        }
        @media (max-width: 768px) {
            .settings-grid-container-custom {
                grid-template-columns: 1fr;
            }
        }
        
        /* FIX: Explicit background colors for visual distinction (using !important to bypass overrides) */
        .schedule-container { background-color: #eef2ff !important; /* Indigo-50 */ }
        .settings-column-one-bg { background-color: #f0fff4 !important; /* Emerald-50 */ }
        .settings-column-two-bg { background-color: white !important; }

        /* Modal Styles */
        .modal {
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            opacity: 0;
            z-index: 50;
        }
        .modal.active {
            pointer-events: auto;
            opacity: 1;
        }
        
        /* Collapsible Button Styling */
        .collapsible-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
    </style>
</head>
<body class="bg-background min-h-screen p-4 sm:p-8 font-sans">
    
    <!-- FIREBASE AND DRAG-N-DROP IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, getDoc, updateDoc, query, where, arrayRemove, arrayUnion, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for access by non-module script
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection, getDocs, getDoc, updateDoc, query, where, arrayRemove, arrayUnion, setLogLevel };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6 p-4 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-gray-900">Full Moon Week Posting</h1>
        </header>
        
        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-xl shadow-md">
            <button id="tab-editor-btn" onclick="showTab('editor')" class="tab-button active flex-1 py-3 text-center transition duration-150">
                <svg class="w-5 h-5 inline mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002 2h2a2 2 0 002-2"></path></svg>
                Event
            </button>
            <button id="tab-settings-btn" onclick="showTab('settings')" class="tab-button flex-1 py-3 text-center transition duration-150">
                <svg class="w-5 h-5 inline mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.323 1.144.38 1.724.161v-4.04z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Settings
            </button>
            <button id="tab-scheduler-btn" onclick="showTab('scheduler')" class="tab-button flex-1 py-3 text-center transition duration-150">
                <svg class="w-5 h-5 inline mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Schedule
            </button>
             <button id="tab-calendar-btn" onclick="showTab('calendar')" class="tab-button flex-1 py-3 text-center transition duration-150">
                <svg class="w-5 h-5 inline mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Calendar
            </button>
            <button id="tab-history-btn" onclick="showTab('history')" class="tab-button flex-1 py-3 text-center transition duration-150">
                <svg class="w-5 h-5 inline mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                History
            </button>
        </div>

        <!-- MAIN EDITOR TAB -->
        <div id="tab-editor-content" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- INPUT COLUMN (LEFT) -->
                <div class="space-y-6">
                    <!-- Structured Event Input -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <label class="block text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            Event Details
                        </label>

                        <!-- EVENT TEMPLATE LOADER -->
                        <div class="mb-4">
                            <label for="eventTemplateSelect" class="block text-sm font-medium text-gray-700 mb-1">Load Event Template:</label>
                            <select id="eventTemplateSelect" onchange="loadEventTemplate()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                                <option value="">--- Select Event Template ---</option>
                            </select>
                        </div>

                        <div class="space-y-3">
                            <!-- DATE INPUT (DATEPICKER ONLY) -->
                            <div class="flex items-center date-input-container space-x-3">
                                <label for="inputIsoDate" class="flex-shrink-0 text-sm font-medium text-gray-700">ðŸ—“ Event Date:</label>
                                <input type="date" id="inputIsoDate" class="border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                            </div>
                            
                            <input type="text" id="inputEventName" placeholder="ðŸŽ‰ EVENT: " class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                            <input type="text" id="inputLocation" placeholder="ðŸ“ LOCATION: " class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                        </div>
                        
                        <div class="flex justify-between items-center mt-6 mb-2">
                             <label for="rawDescription" class="block text-xl font-semibold text-gray-900 flex items-center">
                                Full Description
                            </label>
                            <!-- INSERT SNIPPET BUTTON/MENU -->
                            <div class="relative inline-block text-left">
                                <button type="button" onclick="document.getElementById('snippetMenu').classList.toggle('hidden')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg text-xs hover:bg-gray-200 transition">
                                    Insert Snippet
                                </button>
                                <div id="snippetMenu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                                        <select id="editorSnippetSelect" onchange="insertSnippet()" class="w-full p-2 text-sm cursor-pointer hover:bg-gray-100">
                                            <option value="">--- Select Snippet ---</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <textarea id="rawDescription" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-primary focus:border-primary transition duration-150" placeholder=""></textarea>

                        <label for="extraHashtagsInput" class="block text-sm font-medium text-gray-700 mt-4 mb-2">
                            Extra Hashtags (Comma-separated)
                        </label>
                        <input type="text" id="extraHashtagsInput" placeholder="" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-primary focus:border-primary transition duration-150">
                    </div>
                    
                    <!-- File Mockup -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                           <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                                Images/Videos
                            </h2>
                        <input type="file" id="mediaUpload" class="w-full text-sm text-gray-500 border border-gray-300 rounded-lg p-2">
                        <button onclick="generateFileName()" class="mt-3 w-full py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">
                            Generate Suggested Filename
                        </button>
                        <p id="fileNameOutput" class="text-xs text-gray-700 mt-2 break-all"></p>
                    </div>
                </div>

                <!-- OUTPUT & ACTION COLUMN (RIGHT) -->
                <div class="space-y-6">
                    
                    <!-- FIX: Action (Moved to Top of Output Column & shrunk buttons) -->
                    <div class="bg-indigo-50/50 p-4 rounded-xl shadow-lg flex flex-col sm:flex-row items-center justify-between">
                        <div id="statusMessage" class="mt-4 sm:mt-0 text-sm text-gray-600 w-full mb-3 sm:mb-0 text-center sm:text-left">Awaiting Firebase Connection...</div>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full justify-end">
                            <button id="parseButton" onclick="handleClick(false)" class="w-full sm:w-auto px-4 py-2 bg-primary text-white font-bold rounded-full shadow-md hover:bg-indigo-600 transition duration-300 transform hover:scale-105 text-sm">
                                PARSE
                            </button>
                            <button id="saveScheduleButton" onclick="handleClick(true)" class="w-full sm:w-auto px-4 py-2 bg-accent text-white font-bold rounded-full shadow-md hover:bg-amber-600 transition duration-300 transform hover:scale-105 text-sm">
                                SAVE TO SCHEDULE
                            </button>
                        </div>
                    </div>

                    <!-- OUTPUT BOXES (Stacked) -->
                    <div class="space-y-4">
                        <!-- Post Text -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <label for="calendarOutput" class="block text-xl font-semibold text-gray-900 mb-2 flex items-center">
                                Post/Reel Text
                            </label>
                            <textarea id="calendarOutput" onblur="updateTextOutput('calendarOutput')" class="w-full border border-gray-300 rounded-lg p-3 bg-white min-h-[250px]" placeholder="Formatted post data will appear here."></textarea>
                        </div>
                        
                        <!-- Story Tags -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <label for="tagsOnlyOutput" class="block text-xl font-semibold text-gray-900 mb-2 flex items-center">
                                Story Tags
                            </label>
                            <textarea id="tagsOnlyOutput" onblur="updateTextOutput('tagsOnlyOutput')" class="w-full border border-gray-300 rounded-lg p-3 bg-gray-50 min-h-[150px]" placeholder="Only unique @tags, one per line, will appear here."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB (Layout Reverted to Screenshot Look) -->
        <div id="tab-settings-content" class="tab-content hidden">
            <!-- FIX: Grid with 30%/70% split, only collapsing to 1 column below 768px -->
            <div class="settings-grid-container-custom">
                
                <!-- Column 1: Tags, List, New Entry, Bulk Import (30% width) -->
                <div class="space-y-6">
                    <div class="settings-column-one-bg p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m-4 12v-2m4-10v2m-4 8v2m4-10v2m-4 8v2m4-10v2m-4 8v2m4-10v2m-4 8v2m4-10v2"></path></svg>
                            Tags
                        </h2>
                        
                        <!-- Filter & Search (Top of Tags Box) -->
                        <div class="space-y-3 mb-4">
                            <select id="categoryFilter" onchange="renderNameMap()" class="p-2 border border-gray-300 rounded-lg text-sm w-full">
                                <option value="">All Categories</option>
                                <option value="DJ">DJ</option>
                                <option value="Venue">Venue</option>
                                <option value="Presenter">Presenter</option>
                                <option value="Artist">Artist</option>
                                <option value="Label">Label</option>
                                <option value="Other">Other</option>
                            </select>
                            <input type="text" id="nameSearch" oninput="renderNameMap()" placeholder="Search by Name or Tag..." class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                        </div>

                        <!-- Current List Display (The visible tags list) -->
                        <div class="max-h-96 overflow-y-scroll border border-gray-300 rounded-lg p-3 bg-gray-50">
                            <ul id="databaseList" class="divide-y divide-gray-200">
                                <!-- List items rendered here -->
                            </ul>
                            <p id="emptyListMessage" class="text-center text-gray-500 italic hidden mt-4">No entries found matching your filter/search criteria.</p>
                        </div>

                    </div>
                    
                    <!-- Add New Entry (Matches screenshot look) -->
                    <div class="settings-column-one-bg p-6 rounded-xl shadow-lg border border-secondary/50">
                             <h2 class="text-lg font-semibold text-gray-900 mb-3">Add New Tag:</h2>
                            <div class="space-y-3">
                                <input type="text" id="newName" placeholder="Name (e.g., John Smith)" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-secondary focus:border-secondary">
                                <input type="text" id="newTag" placeholder="Tag (e.g., @JohnSmithOfficial)" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-secondary focus:border-secondary">
                                <select id="newCategory" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-secondary focus:border-secondary">
                                    <option value="DJ">DJ</option>
                                    <option value="Venue">Venue</option>
                                    <option value="Presenter">Presenter</option>
                                    <option value="Artist">Artist</option>
                                    <option value="Label">Label</option>
                                    <option value="Other">Other</option>
                                </select>
                                <button onclick="addNameMapEntry()" class="w-full py-2 bg-secondary text-white font-bold rounded-lg hover:bg-emerald-600 transition duration-200">
                                    Save
                                </button>
                                <p id="addStatus" class="text-xs mt-1"></p>
                            </div>
                    </div>
                        
                    <!-- Bulk Upload (Matches screenshot look) -->
                    <div class="settings-column-one-bg p-6 rounded-xl shadow-lg border border-accent/50">
                             <h2 class="text-lg font-semibold text-gray-900 mb-3">Bulk Tag Database Import</h2>
                            <!-- FIX: Reverted description to include Tab-separated values -->
                            <p class="text-xs text-gray-700">Paste raw spreadsheet data (Name, @Tag, Category) below, or JSON, to merge with the cloud list.</p>
                            <button onclick="copyInitialInstaMap()" class="mt-3 px-3 py-1 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-xs">Copy Default Map JSON</button>
                            <textarea id="bulkInstaMapInput" placeholder='Name	@Tag	Category (Tab-separated)' class="w-full border border-gray-300 rounded-lg p-2 text-xs min-h-[100px]"></textarea>
                            <button onclick="bulkImportTags()" class="w-full py-2 bg-accent text-white font-bold rounded-lg hover:bg-amber-600 transition duration-200 text-sm">
                                IMPORT TAGS
                            </button>
                            <p id="bulkStatus" class="text-xs mt-1"></p>
                    </div>

                </div>

                <!-- Column 2: Global Settings, Snippets, Templates (70% width) -->
                <div class="space-y-6 flex flex-col">
                    
                    <!-- Global Default Hashtags (Moved to the top of the second column) -->
                    <div class="settings-column-two-bg p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Global Default Hashtags
                        </h2>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tags added to all events. (Comma-separated)</label>
                        <textarea id="defaultTagsInput" onblur="saveGlobalHashtags()" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-accent focus:border-accent transition duration-150" placeholder=""></textarea>
                         <p id="globalTagsStatus" class="text-xs mt-1"></p>
                    </div>

                    <!-- Reusable Text Snippets -->
                    <div class="settings-column-two-bg p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Reusable Text Snippets
                        </h2>
                         <div class="space-y-3">
                            <select id="snippetSelect" onchange="loadSnippet()" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                                <option value="">--- Load Snippet ---</option>
                            </select>
                            <textarea id="snippetContent" onblur="saveSnippet()" placeholder="" class="w-full border border-gray-300 rounded-lg p-3 text-sm min-h-[180px]"></textarea>
                            <div class="flex space-x-2">
                                <input type="text" id="snippetName" placeholder="Snippet Name" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm">
                                <button onclick="saveSnippet()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">Save</button>
                            </div>
                            <p id="snippetStatus" class="text-xs mt-1"></p>
                        </div>
                    </div>

                    <!-- Recurring Event Templates -->
                    <div class="settings-column-two-bg p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Recurring Event Templates
                        </h2>
                         <div class="space-y-3">
                            <input type="text" id="eventDbName" placeholder="Template Name (e.g., Utopia Festival)" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                             <button onclick="saveEventTemplate()" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-indigo-600 transition text-sm">Save Current Input as Template</button>
                             <div id="eventDbList" class="max-h-32 overflow-y-auto mt-2 p-2 border border-gray-300 rounded-lg bg-gray-50 text-sm">
                                <!-- List of saved templates will appear here -->
                             </div>
                             <p id="eventTemplateStatus" class="text-xs mt-1"></p>
                        </div>
                    </div>

                    <!-- Media Link Management -->
                    <div class="settings-column-two-bg p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Media Source Folder
                        </h2>
                        <label for="mediaFolderLink" class="block text-sm font-medium text-gray-700 mb-2">
                            Google Drive/Cloud Link (Access point for files)
                        </label>
                        <input type="url" id="mediaFolderLink" placeholder="https://drive.google.com/..." onblur="saveMediaFolderLink()" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-secondary focus:border-secondary">
                        <button onclick="saveMediaFolderLink()" class="mt-3 w-full py-2 bg-secondary text-white rounded-lg hover:bg-emerald-600 transition text-sm">
                            Save Folder Link
                        </button>
                        <p id="mediaLinkStatus" class="text-xs mt-1"></p>
                    </div>

                </div>

            </div>
        </div>
        
        <!-- SCHEDULER TAB (NEW) -->
        <div id="tab-scheduler-content" class="tab-content hidden">
             <div class="schedule-container p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                    <svg class="w-7 h-7 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Upcoming Post Schedule
                </h2 >
                <div id="scheduledEventsList" class="space-y-4 cursor-grab">
                    <!-- Scheduled events populated here -->
                </div>
                <p id="emptyScheduleMessage" class="text-center text-gray-500 italic mt-8 hidden">No events currently scheduled.</p>
            </div>
        </div>

        <!-- CALENDAR SUMMARY TAB (NEW) -->
        <div id="tab-calendar-content" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                    <svg class="w-7 h-7 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Full Moon Calendar View
                </h2 >
                <div id="calendarSummaryList" class="space-y-3">
                    <!-- Calendar summary content here -->
                </div>
                <p id="emptyCalendarMessage" class="text-center text-gray-500 italic mt-8 hidden">No events found for summary.</p>
            </div>
        </div>
        
        <!-- HISTORY TAB (NEW) -->
          <div id="tab-history-content" class="tab-content hidden">
             <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                    <svg class="w-7 h-7 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2l-1.5 1.5M12 6l1.5 1.5M4 18h16M4 6h16M12 10a2 2 0 00-2 2v3a2 2 0 002 2h3m0-6h-3a2 2 0 00-2 2v3m-6-6h.01M18 12h.01M6 18h.01"></path></svg>
                    Posting History (Past Events)
                </h2 >
                <div id="historyEventsList" class="space-y-4">
                    <!-- Historical events populated here -->
                </div>
                <p id="emptyHistoryMessage" class="text-center text-gray-500 italic mt-8 hidden">No past events found.</p>
            </div>
        </div>

        <!-- CUSTOM DELETE MODAL -->
        <div id="deleteModal" class="modal fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50" onclick="closeModal()">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold text-red-600 mb-4">Confirm Deletion</h3>
                <p id="modalMessage" class="text-gray-700 mb-6">Are you sure you want to permanently delete this item?</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal(false)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button onclick="closeModal(true)" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- CUSTOM PROMPT MODAL (New - for template saving and other text inputs) -->
        <div id="promptModal" class="modal fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50" onclick="closePromptModal(null)">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto w-full" onclick="event.stopPropagation()">
                <h3 id="promptModalTitle" class="text-lg font-bold text-primary mb-4">Enter Value</h3>
                <input type="text" id="promptModalInput" class="w-full p-2 border border-gray-300 rounded-lg mb-6" placeholder="Template Name">
                <div class="flex justify-end space-x-3">
                    <button onclick="closePromptModal(null)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button onclick="submitPromptModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-indigo-600">Submit</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        
        // --- GLOBAL CONFIGURATION AND FIREBASE SETUP ---
        var DB_CONFIG = {
            INSTA_DB_KEY: 'nameTagDatabase',
            EVENT_DB_KEY: 'eventDatabase',
            SNIPPETS_KEY: 'textSnippets',
            SCHEDULE_DB_KEY: 'eventSchedule',
            MEDIA_LINK_KEY: 'mediaLink', 
            GLOBAL_TAGS_KEY: 'globalTags', 
            CATEGORIES: ["DJ", "Venue", "Presenter", "Artist", "Label", "Other"]
        };
        var CATEGORIES = DB_CONFIG.CATEGORIES; 

        // Global Firebase references
        var db = null;
        var auth = null;
        var userId = null;
        var appId = (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
        
        // --- GLOBAL DATA STORES (Updated via Firestore Listeners) ---
        var nameTagDatabase = {}; 
        var eventDatabase = {};    
        var textSnippets = {};     
        var eventSchedule = [];    
        var mediaFolderLink = ''; 
        var globalTagsString = "fullmoonweek, fullmoonparty, kohphangan, thailand, parties, fullmoonpartykohphangan"; // Initial value
        
        let resolveModalPromise = null;
        let resolvePromptPromise = null; // New global for prompt modal
        let currentEditingName = null;

        // ====================================================================
        // CRITICAL FIX: MOVE FIREBASE INIT AND AUTH FUNCTIONS TO THE TOP
        // ====================================================================

        async function initializeFirebase() {
            if (typeof firebase === 'undefined' || !firebase.initializeApp) {
                console.error("Firebase library not loaded.");
                return;
            }
            
            try {
                // --- START: CUSTOM FIREBASE CONFIGURATION BLOCK ---
                // *** REQUIRED FOR GITHUB PAGES/EXTERNAL DEPLOYMENT ***
                const EXTERNAL_FIREBASE_CONFIG = {
                    apiKey: "AIzaSyBGESFzwqoO9lQivws195udUCo6MXnHeHc", 
                    authDomain: "full-moon-week.firebaseapp.com",
                    projectId: "full-moon-week",
                    storageBucket: "full-moon-week.firebasestorage.app",
                    messagingSenderId: "1064130029135", 
                    appId: "1:1064130029135:web:32b8a8a4414a7ed4036c3a",
                    measurementId: "G-3SS3BJQCRN"
                };
                // --- END: CUSTOM FIREBASE CONFIGURATION BLOCK ---
                    
                const configToUse = (typeof __firebase_config !== 'undefined' && __firebase_config.length > 2) 
                    ? JSON.parse(__firebase_config) 
                    : EXTERNAL_FIREBASE_CONFIG;
                    
                if (!configToUse.projectId || configToUse.projectId === "full-moon-week") { 
                    // This block will be used when running on GitHub Pages
                }

                const app = firebase.initializeApp(configToUse);
                auth = firebase.getAuth(app);
                db = firebase.getFirestore(app);
                firebase.setLogLevel('error'); // Suppress verbose warnings

                await authenticateUser();
                await loadInitialDataAndListen(); 
                
                document.getElementById('statusMessage').textContent = 'Ready to parse. Connected to Cloud Sync.';
                document.getElementById('statusMessage').className = 'mt-4 sm:mt-0 text-sm text-gray-600 w-full text-center sm:text-left';

            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                document.getElementById('statusMessage').textContent = 'ERROR: Firebase failed to connect. Data will not sync.';
                document.getElementById('statusMessage').className = 'mt-4 sm:mt-0 text-sm text-red-600 font-bold w-full text-center sm:text-left';
            }
        }

        async function authenticateUser() {
            // FIX: Restructured to guarantee userId is set using the immediate result of sign-in,
            // preventing data loss due to asynchronous timing issues with onAuthStateChanged.
            const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            try {
                if (initialToken) {
                    await firebase.signInWithCustomToken(auth, initialToken);
                } else {
                    await firebase.signInAnonymously(auth);
                }
                
                // If the sign-in was successful, auth.currentUser is set.
                if (auth.currentUser) {
                    userId = auth.currentUser.uid;
                } else {
                     // Fallback: This should ideally not happen if sign-in promises resolved, but acts as a safeguard.
                    console.error("Sign-in resolved but auth.currentUser is null. Using random ID.");
                    userId = crypto.randomUUID();
                }

            } catch (e) {
                console.error("Authentication failed, falling back to anonymous/random ID.", e);
                
                // If sign-in fails entirely (e.g., bad token), sign in anonymously as a last resort
                if (!auth.currentUser) {
                    try {
                        await firebase.signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    } catch (anonError) {
                         console.error("Anonymous sign-in also failed. Using random ID. Data access is blocked.", anonError);
                         userId = crypto.randomUUID();
                    }
                }
            }
            
            // Always return a resolved promise equivalent to maintain flow consistency
            return Promise.resolve(!!auth.currentUser);
        }

        function getDocRef(collectionName, docId) {
            if (!db || !userId) throw new Error("Firebase or User not initialized.");
            return firebase.doc(db, `/artifacts/${appId}/users/${userId}/${collectionName}/${docId}`);
        }
        
        function mapToData(map) {
            return { data: map, lastUpdated: new Date().toISOString() };
        }
        function dataToMap(data) {
            return data.data || {};
        }

        async function saveDataToFirestore(collectionName, data) {
            if (!db || !userId) {
                console.error("Database not ready. Saving failed.");
                return;
            }

            try {
                const docRef = getDocRef(collectionName, 'main'); 
                
                if (collectionName === DB_CONFIG.SCHEDULE_DB_KEY) {
                    await firebase.setDoc(docRef, { events: data, lastUpdated: new Date().toISOString() });
                } else if (collectionName === DB_CONFIG.MEDIA_LINK_KEY) {
                    await firebase.setDoc(docRef, { link: data });
                } else if (collectionName === DB_CONFIG.GLOBAL_TAGS_KEY) {
                    await firebase.setDoc(docRef, { tags: data, lastUpdated: new Date().toISOString() });
                } else {
                    await firebase.setDoc(docRef, mapToData(data));
                }
                
            } catch (e) {
                console.error(`Error saving ${collectionName} to Firestore:`, e);
            }
        }

        async function loadInitialDataAndListen() {
            if (!db || !userId) return;

            const collections = [
                { name: DB_CONFIG.INSTA_DB_KEY, render: renderNameMap, default: getInitialInstaMap(), globalVar: nameTagDatabase, type: 'map' },
                { name: DB_CONFIG.EVENT_DB_KEY, render: renderEventTemplateSelect, default: {}, globalVar: eventDatabase, type: 'map' },
                { name: DB_CONFIG.SNIPPETS_KEY, render: renderSnippetSelect, default: {}, globalVar: textSnippets, type: 'map' },
                { name: DB_CONFIG.SCHEDULE_DB_KEY, render: renderScheduleList, default: [], globalVar: eventSchedule, type: 'array' },
                { name: DB_CONFIG.MEDIA_LINK_KEY, render: renderMediaLink, default: '', globalVar: mediaFolderLink, type: 'link' },
                { name: DB_CONFIG.GLOBAL_TAGS_KEY, render: renderGlobalTags, default: globalTagsString, globalVar: window.globalTagsString, type: 'string' }
            ];

            for (const { name, render, default: defaultData, globalVar, type } of collections) {
                const docRef = getDocRef(name, 'main');
                
                const docSnap = await firebase.getDoc(docRef);
                if (!docSnap.exists() && Object.keys(defaultData).length > 0) {
                    await saveDataToFirestore(name, defaultData);
                }

                firebase.onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        
                        if (type === 'array') {
                            globalVar.splice(0, globalVar.length, ...(data.events || []));
                            // FIX: Ensure schedule is always sorted by date immediately after load
                            globalVar.sort((a, b) => new Date(a.date) - new Date(b.date));
                        } else if (type === 'link') {
                            window.mediaFolderLink = data.link || '';
                        } else if (type === 'string') {
                             window.globalTagsString = data.tags || defaultData;
                        } else if (type === 'map') {
                            const loadedMap = dataToMap(data); 
                            for (const prop in globalVar) { delete globalVar[prop]; }
                            Object.assign(globalVar, loadedMap);
                        }
                    } 
                    render();
                }, (error) => {
                    console.error(`Error listening to ${name}:`, error);
                });
            }
        }


        // --- UTILITY FUNCTIONS ---
        // FIX: Moved all utility functions here for immediate hoisting and accessibility
        
        function getTodayIsoString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function copyToClipboard(text) {
            // FIX: Use document.execCommand('copy') as navigator.clipboard.writeText is blocked in iframes
            // The existing implementation already handles this, maintaining it for robustness.
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).catch(err => {
                    console.error('Could not copy text using navigator.clipboard (using fallback): ', err);
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed'; // Prevents scrolling to bottom
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        console.log('Text copied using execCommand.');
                    } catch (e) {
                        console.error('Fallback copy method failed too:', e);
                    }
                    document.body.removeChild(textarea);
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }
        
        function formatDateFriendly(isoDate) {
            if (!isoDate) return 'TBD Date';
            try {
                const date = new Date(isoDate + 'T00:00:00'); // Append time to prevent timezone issues
                return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            } catch (e) {
                return isoDate;
            }
        }
        
        function dateDifference(date1, date2) {
            // Calculates difference in full days, crucial for sequential numbering
            const date1Time = date1.getTime();
            const date2Time = date2.getTime();
            const diffTime = Math.abs(date2Time - date1Time);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function generateFileName() {
            const date = document.getElementById('inputIsoDate').value.trim();
            const location = document.getElementById('inputLocation').value.trim();

            if (!date || !location) {
                document.getElementById('fileNameOutput').textContent = "Enter Date and Location to generate filename.";
                return 'N/A';
            }

            const d = new Date(date + 'T00:00:00');
            const month = d.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
            const day = String(d.getDate()).padStart(2, '0');
            
            const cleanLocation = location
                .replace(/[^a-zA-Z0-9\s]/g, '')
                .trim()
                .replace(/\s+/g, '_')
                .toUpperCase();

            const filename = `${day}${month}-${cleanLocation}`;
            
            document.getElementById('fileNameOutput').textContent = `${filename}.jpg/mp4 (Copy Manually)`;
            return filename;
        }

        function updateTextOutput(id) { /* Placeholder */ }
        
        // --- MODAL CONFIRMATION (for reliable deletion) ---

        function openModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('deleteModal').classList.add('active');
            return new Promise(resolve => {
                resolveModalPromise = resolve;
            });
        }

        function closeModal(confirmed) {
            document.getElementById('deleteModal').classList.remove('active');
            if (resolveModalPromise) {
                resolveModalPromise(confirmed);
                resolveModalPromise = null;
            }
        }
        
        // --- PROMPT MODAL (New - for text input/renaming/template saving) ---
        
        function openPromptModal(title, defaultValue = '') {
            document.getElementById('promptModalTitle').textContent = title;
            const inputEl = document.getElementById('promptModalInput');
            inputEl.value = defaultValue;
            inputEl.placeholder = title; 
            document.getElementById('promptModal').classList.add('active');
            
            // Focus the input when the modal is opened
            setTimeout(() => inputEl.focus(), 100);

            return new Promise(resolve => {
                resolvePromptPromise = resolve;
            });
        }

        function closePromptModal(value) {
            document.getElementById('promptModal').classList.remove('active');
            if (resolvePromptPromise) {
                resolvePromptPromise(value);
                resolvePromptPromise = null;
            }
        }

        function submitPromptModal() {
            const value = document.getElementById('promptModalInput').value.trim();
            closePromptModal(value);
        }
        
        // --- DATA STRUCTURES ---

        function getInitialInstaMap() {
             return {"2nd Floor Sunset Bar":{"tag":"@2ndfloor.sunsetbar","category":"Venue"},"3MAN":{"tag":"@3man_uk","category":"DJ"},"Aaron Suiss":{"tag":"@aaronsuissofficial","category":"DJ"},"Aatma":{"tag":"@aatmawithin","category":"DJ"},"Abro":{"tag":"@abro.ofc","category":"DJ"},"Acker":{"tag":"@acker_phangan","category":"DJ"},"Acrobat":{"tag":"@acrobat.music","category":"DJ"},"Adi Oren":{"tag":"@_adioren_","category":"DJ"},"Adi Shabat":{"tag":"@adishabat_","category":"DJ"},"AFTERLIFE label":{"tag":"@afterlife_ofc","category":"Label"},"Akshit Shetty":{"tag":"@akshit_shetty","category":"DJ"},"Alan Koh":{"tag":"@alan.island_","category":"DJ"},"Alviker":{"tag":"@alviker","category":"DJ"},"Amiram":{"tag":"@ami_rising_dust","category":"DJ"},"Angelika":{"tag":"@djangelikaofficial","category":"DJ"},"Anna Panilli":{"tag":"@annapanilli","category":"DJ"},"Annabelle":{"tag":"@djparty_kohphangan","category":"DJ"},"Anuyut":{"tag":"@living_things_studio","category":"DJ"},"Apnea":{"tag":"@apneanarchy","category":"DJ"},"Apple Bar, Haad Yao":{"tag":"@applebarhaadyao","category":"Venue"},"Aracil":{"tag":"@aracil_official","category":"DJ"},"Armi":{"tag":"@djarmikp","category":"DJ"},"ArtCore":{"tag":"@ron_levanon_artcore","category":"Artist"},"Artur Snake":{"tag":"@artursnakefilm","category":"DJ"},"Assaf Almog":{"tag":"@dj_assaf_almog","category":"DJ"},"Astrida":{"tag":"@astrida_astridakini","category":"DJ"},"Atman Ananda":{"tag":"@atmanananda_dj","category":"DJ"},"AUM Sound Healing Center":{"tag":"@aumsoundhealing","category":"Venue"},"B.E.M.E.T":{"tag":"@b_e_m_e_t","category":"DJ"},"B14CKPE4R1S":{"tag":"@_b14ckpe4r1s_","category":"DJ"},"B4gle":{"tag":"@b4gle","category":"DJ"},"Back to Donnie":{"tag":"@donniemusic","category":"DJ"},"Bambu":{"tag":"@bambuhuts","category":"Venue"},"Bank Waterfall":{"tag":"@Bank_Waterfall","category":"DJ"},"Barak White":{"tag":"@barakwhite","category":"DJ"},"Bata":{"tag":"@batasamuilover","category":"Artist"},"Bello":{"tag":"@BelloDJ","category":"Category"},"Berry Linn":{"tag":"@Berry_Linn","category":"DJ"},"Big Splash":{"tag":"@Big_Splash_DnBPresenter","category":"Presenter"},"Black Barrel":{"tag":"@blackbarrel_leocap","category":"DJ"},"Black Venus":{"tag":"@blackvenus__","category":"DJ"},"Bluerama":{"tag":"@bluerama_official","category":"Venue"},"Boyonic":{"tag":"@boyonic7","category":"DJ"},"Brahma":{"tag":"@brahma_music","category":"DJ"},"Bushwacka!":{"tag":"@bushwacka","category":"DJ"},"Cafe 13 Koh Phangan":{"tag":"@cafe13_kohphangan","category":"Venue"},"Cartel De Los Amigos":{"tag":"@carteldelosamigos","category":"Presenter"},"Chill Up":{"tag":"@chill_up_phangan","category":"Venue"},"Chupis":{"tag":"@mr_chupis","category":"DJ"},"Cleo P":{"tag":"@djcleop","category":"DJ"},"Cocoyard":{"tag":"@cocoyard.th","category":"Venue"},"Cosimo Scimo":{"tag":"@cosimoscimo33_45","category":"DJ"},"Cosmic Vibes":{"tag":"@djcosmicvibes","category":"DJ"},"Cosmosis":{"tag":"@cosmosis1","category":"DJ"},"Crealab108":{"tag":"@crealab108_uv_artwork","category":"Artist"},"Culture Club":{"tag":"@cultureclub.kpg","category":"Venue"},"D-Unity":{"tag":"@d_unity","category":"DJ"},"Dalah":{"tag":"@dalahfr","category":"DJ"},"Dani V":{"tag":"@ddjdaniv","category":"DJ"},"Darco":{"tag":"@____darco____","category":"DJ"},"Darin Epsilon":{"tag":"@darinepsilon","category":"DJ"},"Darragh Casey":{"tag":"@darraghcasey","category":"DJ"},"Darwish":{"tag":"@djdarwish","category":"DJ"},"Dava Di Toma":{"tag":"@davaditoma","category":"DJ"},"David Chong":{"tag":"@dj_david_chong","category":"DJ"},"Deborah De Luca":{"tag":"@deborahdeluca","category":"DJ"},"Denium":{"tag":"@hill","category":"DJ"},"Denoit has been changed to Denium, this is to ensure that the code is correct, and will not cause an error.":{"tag":"@denishorvat","category":"DJ"},"Dennis Lee":{"tag":"@djdennislee","category":"DJ"},"Dennyck":{"tag":"@davidenicolucci","category":"DJ"},"Densoner":{"tag":"@dens_oner","category":"DJ"},"Desert Sail":{"tag":"@desert_sail_music","category":"DJ"},"Dima Odivo":{"tag":"@dima_odivo","category":"DJ"},"Disco Boi":{"tag":"@yigital_","category":"DJ"},"DJ Bishh":{"tag":"@dj.bishh","category":"DJ"},"DJ Danny Dan":{"tag":"@danny_trunprodigital","category":"DJ"},"DJ Darkus":{"tag":"@djdarkus12","category":"DJ"},"DJ Flim":{"tag":"@djflimofficial","category":"DJ"},"DJ Noize":{"tag":"@noizefmp","category":"DJ"},"DJ NOT":{"tag":"@djjj_not","category":"DJ"},"DJ NowAnanda":{"tag":"@nowananda.music","category":"DJ"},"DJ Profile":{"tag":"@djprofileuk","category":"DJ"},"DJ Sith":{"tag":"@djsith555","category":"DJ"},"DJ Yam":{"tag":"@djy.a.m.","category":"DJ"},"DJ Yamagushi":{"tag":"@dj.yamagushi","category":"DJ"},"DJâ€‹xMC Paekingboom":{"tag":"@pae_kingboom","category":"DJ"},"Doc":{"tag":"@doc.moh77","category":"DJ"},"Dovetail":{"tag":"@dovetail.sounds","category":"DJ"},"Dr. Knows":{"tag":"@mr.andidressler","category":"DJ"},"Dragos":{"tag":"@dragos_kpg","category":"DJ"},"Dust":{"tag":"@dustlooneymoon","category":"DJ"},"Dusty Kid":{"tag":"@dustykid_official","category":"DJ"},"Dyslex":{"tag":"@dyslex_phangan","category":"DJ"},"E-Mook":{"tag":"@dj_e.mook","category":"DJ"},"Echo Beach":{"tag":"@echo_beach_hostel","category":"Venue"},"Eden Party":{"tag":"@edengarden_kohphangan","category":"Venue"},"El Gluck":{"tag":"@el.gluck","category":"DJ"},"Electrom":{"tag":"@electromdj","category":"DJ"},"Eli Cicada":{"tag":"@eli.cicada","category":"DJ"},"Erkin Ekici":{"tag":"@erkinekicii","category":"DJ"},"Esterlis":{"tag":"@alex_esterlis","category":"DJ"},"eva180":{"tag":"@eva_brabus_180","category":"DJ"},"Evgeny Sviridov":{"tag":"@evgeny.sviridov_ofc","category":"DJ"},"ð”½ð”¸ð”½ð”¸ (People on Top)":{"tag":"@fafa.peopleontop","category":"DJ"},"Farid":{"tag":"@farid__ofc","category":"DJ"},"Felon MC":{"tag":"@felonmc","category":"DJ"},"Fred Canal":{"tag":"@fredcanal","category":"DJ"},"Freestylers":{"tag":"@thefreestylersofficial","category":"DJ"},"Funkintao":{"tag":"@vroom.music","category":"DJ"},"Fuziger":{"tag":"@FuzigerDJ","category":"DJ"},"Gadi Schneider":{"tag":"@gadi__schneider","category":"DJ"},"Gana Eden":{"tag":"@gana_eden","category":"DJ"},"Gayatree":{"tag":"@dj_osman_gayatree","category":"DJ"},"Genetica":{"tag":"@genetica_music","category":"DJ"},"Gera Dzhio":{"tag":"@gera_dzhio","category":"DJ"},"Ghost Rider":{"tag":"@ghostrider.music","category":"DJ"},"Gily":{"tag":"@iamgily","category":"DJ"},"Global Flaming":{"tag":"@global_flaming","category":"Artist"},"Golo":{"tag":"@omergolo","category":"DJ"},"Goodman":{"tag":"@GoodmanDJ","category":"DJ"},"Gorovich":{"tag":"@gorovich_official","category":"DJ"},"Graham Gold":{"tag":"@djgrahamgold","category":"DJ"},"Grasshopper Bar":{"tag":"@grasshopperbeachbar","category":"Venue"},"Greg Hilight Tribe":{"tag":"@greghilight","category":"DJ"},"Groovy Tunes":{"tag":"@groovytunes__","category":"Presenter"},"Gunnar Stiller":{"tag":"@gunnarstiller","category":"DJ"},"Guyâ€™s Bar":{"tag":"@guysbarthailand","category":"Venue"},"Guybro":{"tag":"@guyboyangu","category":"DJ"},"Half Moon Festival":{"tag":"@halfmoon.festival","category":"Venue"},"Happy People":{"tag":"@_happy_people_events_","category":"Presenter"},"Harmony Beach Club":{"tag":"@harmonybeachclub","category":"Venue"},"Hioko":{"tag":"@hioko_yo","category":"DJ"},"Hippapa":{"tag":"@real_hippapa","category":"DJ"},"Holice":{"tag":"@holice___","category":"DJ"},"Hollystone":{"tag":"@hollystonephangan","category":"Venue"},"Hooligan":{"tag":"@hooligan_koh_phangan","category":"Venue"},"Hot Stuff":{"tag":"@hot_stuff_phangan","category":"Presenter"},"Hujaboy":{"tag":"@hujaboy","category":"DJ"},"Hybrid UV":{"tag":"@hybriduv","category":"Artist"},"Imagine Mars":{"tag":"@imaginemarsmusic","category":"DJ"},"Infinity Beach Club":{"tag":"@infinitykohphangan","category":"Venue"},"Insomnia Bar":{"tag":"@insomnia_koh_phangan","category":"Venue"},"Islandboy":{"tag":"@islandboy_og","category":"DJ"},"Istina":{"tag":"@djistina_vlubvi","category":"DJ"},"Ivan Croz":{"tag":"@ivancroz","category":"Artist"},"Jaybee":{"tag":"@dnbjaybee","category":"DJ"},"Jo Moontribe":{"tag":"@jomoontribe","category":"DJ"},"Joe Rickard":{"tag":"@joe.rickard.547","category":"DJ"},"Jonny T Fusion":{"tag":"@jonnytribalfusion","category":"DJ"},"Jordan Love":{"tag":"@dj.jordanlove","category":"DJ"},"Juan Verdera":{"tag":"@juanverderafernandez","category":"DJ"},"Julia Kosjakova":{"tag":"@kosjakova","category":"Artist"},"Jungle Experience Festival":{"tag":"@jungleexperiencekohphangan","category":"Venue"},"Kai Vice":{"tag":"@kaivice_music","category":"DJ"},"Kaliko Flow":{"tag":"@kalikoflow","category":"DJ"},"Kasat Ka":{"tag":"@kasatka_dj","category":"DJ"},"Kat":{"tag":"@djkat.music","category":"DJ"},"Kia Goa":{"tag":"@djkia_goa","category":"DJ"},"KIKKAT":{"tag":"@kikkat.music","category":"DJ"},"KINGS CVSTLE":{"tag":"@KingsCvstle","category":"DJ"},"Klang Therapie":{"tag":"@klangtherapie_","category":"DJ"},"Konos":{"tag":"@konosmusic","category":"DJ"},"Konstantin Sibold":{"tag":"@konstantinsibold","category":"DJ"},"Kreis":{"tag":"@thibaut_kreis","category":"DJ"},"Kris Nami":{"tag":"@kris.nami","category":"DJ"},"Kuma":{"tag":"@kuma.musique","category":"DJ"},"Kyzersan":{"tag":"@kyzersan","category":"DJ"},"L'il Chai":{"tag":"@lilchai_16","category":"DJ"},"Laroz":{"tag":"@larozmusic","category":"DJ"},"Lazykay":{"tag":"@l.a.z.y.k.a.y","category":"DJ"},"Le Club Koh Phangan":{"tag":"@leclubkohphangan","category":"Venue"},"Lee Doron":{"tag":"@leedoron15","category":"DJ"},"Leon Mester":{"tag":"@leon_phangan","category":"DJ"},"Libra Libur":{"tag":"@libralibur","category":"DJ"},"Lighthouse Koh Phangan":{"tag":"@lighthousekohphangan","category":"Venue"},"Lirixx":{"tag":"@liriezra5","category":"DJ"},"Los Amigos":{"tag":"@LosAmigosDJ","category":"DJ"},"Lugasi":{"tag":"@_lugasi_","category":"DJ"},"Magic Island":{"tag":"@magicisland_bar","category":"Venue"},"Magit Cacoon":{"tag":"@magitcacoon","category":"DJ"},"Marchelo":{"tag":"@djmarchelo","category":"DJ"},"Marco Loco":{"tag":"@marcolocomusic","category":"DJ"},"Marietty":{"tag":"@MariettyDJ","category":"DJ"},"Mark Bale":{"tag":"@markbale","category":"DJ"},"Markuuz":{"tag":"@markuuz_markuuz","category":"DJ"},"Master Mario":{"tag":"@djmastermario","category":"DJ"},"Matan Rivivi":{"tag":"@matanrevivi","category":"DJ"},"Matt-E":{"tag":"@ergotjames","category":"DJ"},"Medussa Music":{"tag":"@medussamusicth","category":"DJ"},"Merkaba Beach Club, Koh Phangan":{"tag":"@merkabasunset","category":"Venue"},"Mesto":{"tag":"@nashemesto.kohphangan","category":"Venue"},"Minty":{"tag":"@mintybelle","category":"DJ"},"MOBIT":{"tag":"@Mobit.Phangan","category":"DJ"},"Moksha Lane":{"tag":"@moksha_lane","category":"DJ"},"Monkey Space":{"tag":"@monkeyspace_ofc","category":"DJ"},"Mono & the Ocean":{"tag":"@mono_and_the_ocean","category":"DJ"},"Monsteras":{"tag":"@djmonsteras","category":"DJ"},"Moon House":{"tag":"@moon.house.beachbar","category":"Venue"},"Moonrise Beach, Koh Phangan":{"tag":"@moonrisebeach_kohphangan","category":"Venue"},"Mr Z":{"tag":"@zifrmusic","category":"DJ"},"Muhla":{"tag":"@therealmuhla","category":"DJ"},"N1RVAAN":{"tag":"@nirvaanmusic_","category":"DJ"},"Nakadia":{"tag":"@nakadia_music","category":"DJ"},"Nastia":{"tag":"@nastia.dj","category":"DJ"},"Nata":{"tag":"@natarusakovsky","category":"DJ"},"Natralist":{"tag":"@jaynatralist","category":"DJ"},"Nebila Deussal":{"tag":"@nebila_deussal","category":"DJ"},"Nicare":{"tag":"@nicaremusic","category":"DJ"},"Nico Pauly":{"tag":"@nico_pauly","category":"DJ"},"Nicola Calbi":{"tag":"@nicola.calbi","category":"DJ"},"Niiya":{"tag":"@niiyamusica","category":"DJ"},"Nilopeech":{"tag":"@nilopeech_meditation","category":"DJ"},"Nima":{"tag":"@nima_shamarli_","category":"DJ"},"Nisa Brown":{"tag":"@nisa_brown","category":"DJ"},"NO:MAD":{"tag":"@nomad_liveset","category":"DJ"},"Omer Bar":{"tag":"@omerbar_official","category":"DJ"},"OMKA":{"tag":"@omri.m.hay","category":"DJ"},"Ã˜NIZÎ›L":{"tag":"@onizalart","category":"Artist"},"Oscar L":{"tag":"@oscarldj","category":"DJ"},"Out of Orbit":{"tag":"@outoforbitofficial","category":"DJ"},"Outsiders":{"tag":"@outsiders_music","category":"DJ"},"OXA Beach":{"tag":"@oxapartykohphangan","category":"Venue"},"OXA Party":{"tag":"@oxapartyphangan","category":"Venue"},"P.H.B.":{"tag":"@fabrice.dj.phb","category":"DJ"},"Pash":{"tag":"@dj_pash_dnb","category":"DJ"},"Peacemaker":{"tag":"@dj_peacemaker_","category":"DJ"},"Persistence":{"tag":"@payton_persistence","category":"DJ"},"Peter G":{"tag":"@petergphangan","category":"DJ"},"Playin' Blind":{"tag":"@playinblind","category":"DJ"},"Poe":{"tag":"@dj_poe","category":"DJ"},"Porat":{"tag":"@poratmusic","category":"DJ"},"Porsche":{"tag":"@Porsche_DJ","category":"DJ"},"Pou":{"tag":"@pou_music_ofc","category":"DJ"},"Presti":{"tag":"@presti.__","category":"DJ"},"Prismatic":{"tag":"@PrismaticDJ","category":"DJ"},"Pyramid":{"tag":"@pyramidkohphangan","category":"Venue"},"Qwent Chang":{"tag":"@qwentchang","category":"DJ"},"R3WIRE":{"tag":"@r3wire","category":"DJ"},"Rasta Home":{"tag":"@RastaHomeKoh","category":"Venue"},"Retro Mountain":{"tag":"@retromountainclubphangan","category":"Venue"},"Retro Mountain Phangan":{"tag":"@retromountainphangan","category":"Venue"},"Ring Of Chain":{"tag":"@_____ringofchain.wav","category":"DJ"},"Rizlablu":{"tag":"@Rizlablu.dnb","category":"DJ"},"Rob Gritton":{"tag":"@robgritton","category":"DJ"},"Roma Dawkins":{"tag":"@roma_dawkins","category":"DJ"},"Ronir":{"tag":"@RonirDJ","category":"DJ"},"Room Service":{"tag":"@room_service_events","category":"Presenter"},"Roymor":{"tag":"@roymor7","category":"DJ"},"Sabaii Bay Beach Club":{"tag":"@sabaiibaybeachclub","category":"Venue"},"Sabrina":{"tag":"@sabrinamadonnacamparifantasie","category":"DJ"},"Sacred Beat":{"tag":"@sacredbeat","category":"DJ"},"Saily":{"tag":"@SailyDJ","category":"DJ"},"Sam Supplier":{"tag":"@samsupplier","category":"DJ"},"Sarina":{"tag":"@sharon_shirr","category":"DJ"},"Sasha Barley":{"tag":"@sasha.barley","category":"DJ"},"Saturn Pub":{"tag":"@saturnpub","category":"Venue"},"Sea Love Beach":{"tag":"@sealovekohphangan","category":"Venue"},"Sean Brauer":{"tag":"@seanbrauerr","category":"DJ"},"SEASIDE Sunset Bar, Koh Phangan":{"tag":"@seaside_sunsetbar_kohphangan","category":"Venue"},"Seebeat":{"tag":"@djseebeat","category":"DJ"},"Selecta G":{"tag":"@selecta_g_aka_damdam","category":"DJ"},"Selecta Snoop":{"tag":"@selecta_snoop","category":"DJ"},"SHALÃ˜S":{"tag":"@shalos__","category":"DJ"},"Sharnea":{"tag":"@sharnea_xo","category":"DJ"},"Shayman":{"tag":"@shayman.official","category":"DJ"},"Sho Sho":{"tag":"@shoshojp","category":"DJ"},"Simon Kruger":{"tag":"@SimonKrugerDJ","category":"DJ"},"Slacky":{"tag":"@___slacky","category":"DJ"},"SNGI":{"tag":"@sngi_alex","category":"DJ"},"Sola":{"tag":"@SolaDJ","category":"DJ"},"Solar Conexion":{"tag":"@solar_conexion","category":"Presenter"},"Somatic Cell":{"tag":"@somatic_cell","category":"DJ"},"Sophie States":{"tag":"@sophiestates_","category":"DJ"},"Space Club Haad Rin":{"tag":"@spaceclub_haadrin","category":"Venue"},"Sphera":{"tag":"@_sphera","category":"DJ"},"Sramanora Bar":{"tag":"@sramanorabar","category":"Venue"},"Stay Gold":{"tag":"@staygold.phangan","category":"DJ"},"Stevie Keys":{"tag":"@djsteviekeys","category":"DJ"},"Sun Diary":{"tag":"@sun_diary_music","category":"DJ"},"Sunset Hill Resort":{"tag":"@sunsethillresort","category":"Venue"},"Suzy Lynx":{"tag":"@SuzyLynx","category":"DJ"},"Swarup":{"tag":"@juarezpetrillo","category":"DJ"},"Syd Gris":{"tag":"@syd_gris","category":"DJ"},"T-Gecko":{"tag":"@t_gecko_music","category":"DJ"},"Talamasca":{"tag":"@talamasca_official","category":"DJ"},"Taz Jacks":{"tag":"@taz_jacks","category":"DJ"},"TEE-O":{"tag":"@theocid_","category":"DJ"},"Telomancer":{"tag":"@telomancer_music","category":"DJ"},"Tezla":{"tag":"@tezla_music","category":"DJ"},"The Element":{"tag":"@theelement____","category":"DJ"},"The Grounds at Siam Cookies Koh Phangan":{"tag":"@thegroundsxsiamcookies","category":"Venue"},"The Waveâ€‹ Sunsetâ€‹":{"tag":"@thewave_sunset","category":"Venue"},"The Wild Side":{"tag":"@thewildside_kohphangan","category":"Venue"},"Timo":{"tag":"@dj.timo.official","category":"DJ"},"Tino Moreno":{"tag":"@tinomoreno77","category":"DJ"},"Tintun":{"tag":"@tintun.tunes","category":"DJ"},"Traumgeist":{"tag":"@traumgeist_dnb","category":"DJ"},"Tripical Note":{"tag":"@tripicalnote_ofc","category":"DJ"},"Tutu":{"tag":"@tom_barnea","category":"DJ"},"Tzvi Sharf":{"tag":"@tzvi.sharf","category":"DJ"},"Unclave":{"tag":"@unclave.phangan","category":"Venue"},"Up to J":{"tag":"@UpToJDJ","category":"DJ"},"UTOPIA Festival":{"tag":"@utopia.events.pro","category":"Venue"},"Vakabular":{"tag":"@djvakabular","category":"DJ"},"Vegas":{"tag":"@vegaslive","category":"DJ"},"Victor Oneoff":{"tag":"@victor_kohphangan","category":"DJ"},"Violyricals":{"tag":"@Violyricals","category":"Artist"},"Waqt":{"tag":"@djchinx_cluster_waqt","category":"DJ"},"Waterfall Festival":{"tag":"@waterfall_festival_official","category":"Venue"},"Waterfall Festival Phangan":{"tag":"@waterfallfestivalphangan","category":"Venue"},"WET Hostel":{"tag":"@wethostel","category":"Venue"},"WET Pool Party":{"tag":"@WETPoolParty","category":"Venue"},"Woodsy":{"tag":"@woodsy.dnb","category":"DJ"},"Yam":{"tag":"@yam.freedom.dj","category":"DJ"},"Yam (Violyricals)":{"tag":"@djy.a.m","category":"DJ"},"Yekumi":{"tag":"@yekumi","category":"DJ"},"YEP Listening Bar":{"tag":"@yep_listening_bar","category":"Venue"},"Yo Logo":{"tag":"@johann.ilpide","category":"DJ"},"Yodafestedelik":{"tag":"@yodafestedelik","category":"DJ"},"Yolozen":{"tag":"@_yolozen","category":"DJ"},"Yugo":{"tag":"@yugo_the_dj","category":"DJ"},"Zeeqar":{"tag":"@zeeqar_","category":"DJ"},"Zero 1 Music":{"tag":"@zero1music","category":"Label"},"Zifr":{"tag":"@zifrmusic","category":"DJ"},"Zig":{"tag":"@d.j.zig","category":"DJ"},"Zoe Azad":{"tag":"@zoeazad","category":"DJ"},"Machet":{"tag":"@nadavmachet","category":"DJ"},"Kudo":{"tag":"@kudo__official","category":"DJ"},"Dano":{"tag":"@DanoYashar","category":"DJ"},"Yashar":{"tag":"@YasharVahid","category":"DJ"},"Vahid":{"tag":"@vahidsadeghzadeh","category":"DJ"},"Ban Sabaii":{"tag":"@ban.sabaii","category":"Venue"},"Jascio":{"tag":"@jascio888","category":"DJ"},"Vincent Vino":{"tag":"@doodleswithvino","category":"Artist"},"Carlton":{"tag":"@carltonthomas90","category":"DJ"},"Matthew":{"tag":"@MatthewMagnus","category":"DJ"},"Magnus":{"tag":"@MagnusFactor50","category":"DJ"},"Factor 50":{"tag":"@Factor50Basner","category":"DJ"},"Basner":{"tag":"@BasnerMae","category":"DJ"},"Mae":{"tag":"@MaeGrooveOne","category":"DJ"},"GrooveOne Agency":{"tag":"@grooveoneagency","category":"Presenter"},"Hole Station":{"tag":"@holestation","category":"Venue"},"Dagda":{"tag":"@djdagda","category":"DJ"},"thenotsofamous":{"tag":"@thenotsofamous","category":"DJ"},"Ankytrixx":{"tag":"@ankytrixx","category":"DJ"},"Damien NÃ«mad":{"tag":"@damiennemad","category":"DJ"},"Ayavi":{"tag":"@ayavi.kandoo","category":"DJ"}}
        }

        // --- UI CONTROL ---
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabName}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}-btn`).classList.add('active');
            
            if (tabName === 'scheduler') {
                renderScheduleList();
                initializeSortable(); 
            } else if (tabName === 'calendar') {
                 renderCalendarSummary();
            } else if (tabName === 'settings') {
                document.getElementById('mediaFolderLink').value = mediaFolderLink;
                document.getElementById('defaultTagsInput').value = globalTagsString;
                renderEditorSnippetSelect();
            } else if (tabName === 'editor') {
                 renderEditorSnippetSelect();
            } else if (tabName === 'history') {
                 renderScheduleList(); // Triggers full list processing which renders history
            }
        }
        
        function toggleCollapsible(id, button) {
            const content = document.getElementById(id);
            const state = button.getAttribute('data-state');
            const svg = button.querySelector('svg');
            
            if (state === 'collapsed') {
                content.classList.remove('hidden');
                button.setAttribute('data-state', 'expanded');
                if(svg) svg.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                button.setAttribute('data-state', 'collapsed');
                if(svg) svg.classList.remove('rotate-180');
            }
        }

        // --- FULL MOON CALENDAR DATES (for grouping) ---
        // Finalized Moon Block Definitions based on user's request (+/- 7 days from peak)
        const FULL_MOON_BLOCKS = [
            // 2025
            { peak: '2025-02-13', name: 'Feb 2025' },
            { peak: '2025-03-13', name: 'Mar 2025' },
            { peak: '2025-04-12', name: 'Apr 2025' },
            { peak: '2025-05-12', name: 'May 2025' },
            { peak: '2025-06-10', name: 'Jun 2025' },
            { peak: '2025-07-12', name: 'Jul 2025' },
            { peak: '2025-08-09', name: 'Aug 2025' },
            { peak: '2025-09-07', name: 'Sep 2025' },
            { peak: '2025-10-08', name: 'Oct 2025' },
            { peak: '2025-11-05', name: 'Nov 2025' },
            { peak: '2025-12-05', name: 'Dec 2025' },
            // Overlapping New Year Block (31 Dec 2025 + 3 Jan 2026) -> Use the first peak for block naming/sorting
            // Keeping this custom name as it spans two months
            { peak: '2025-12-31', name: 'New Year (Dec 2025/Jan 2026)', endPeak: '2026-01-03' }, 
            // 2026 (Starts from 2 Feb, avoiding the combined block above)
            { peak: '2026-02-02', name: 'Feb 2026' },
            { peak: '2026-03-03', name: 'Mar 2026' },
            { peak: '2026-04-02', name: 'Apr 2026' },
            { peak: '2026-05-01', name: 'May 2026' },
            { peak: '2026-05-31', name: 'May/Jun 2026' },
            { peak: '2026-06-29', name: 'Jun 2026' },
            { peak: '2026-07-29', name: 'Jul 2026' },
            { peak: '2026-08-28', name: 'Aug 2026' },
            { peak: '2026-09-26', name: 'Sep 2026' },
            { peak: '2026-10-26', name: 'Oct 2026' },
            { peak: '2026-11-24', name: 'Nov 2026' },
            { peak: '2026-12-24', name: 'Dec 2026' },
        ];


        function assignFullMoonBlock(event) {
            const eventDate = new Date(event.date + 'T00:00:00');
            
            for (const block of FULL_MOON_BLOCKS) {
                const peakDate = new Date(block.peak + 'T00:00:00');
                
                // Calculate span: 7 days before the start peak to 7 days after the end peak (or single peak)
                const endPeakDate = block.endPeak ? new Date(block.endPeak + 'T00:00:00') : peakDate;
                
                const startDate = new Date(peakDate.getTime() - (7 * 24 * 60 * 60 * 1000));
                const endDate = new Date(endPeakDate.getTime() + (7 * 24 * 60 * 60 * 1000));

                if (eventDate >= startDate && eventDate <= endDate) {
                    
                    // FIX: Use the simplified name defined in the constant block array
                    let displayTitle = block.name;
                    
                    return { 
                        ...event, 
                        blockKey: block.peak, 
                        blockName: displayTitle,
                        blockStart: startDate.toISOString().split('T')[0],
                        blockEnd: endDate.toISOString().split('T')[0]
                    };
                }
            }
            return { ...event, blockKey: 'Ungrouped', blockName: 'Ungrouped/Other' };
        }


        function calculateSequentialDays(events) {
            const DAY_RESET_THRESHOLD = 7; // days
            
            if (events.length === 0) return [];
            
            // Ensure events are sorted by date
            const sortedEvents = [...events].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let dayNumber = 0;
            let lastDate = null;
            
            // CRITICAL FIX: Use a for loop to correctly manage the running dayNumber state
            const eventsWithDay = [];
            
            for (const event of sortedEvents) {
                const currentDate = new Date(event.date + 'T00:00:00');
                let newDayNumber = event.dayNumber; // Use existing if available, though it shouldn't be relied upon.
                
                if (!lastDate) {
                    // First event always starts at Day 1
                    newDayNumber = 1;
                } else {
                    const diffDays = dateDifference(lastDate, currentDate);
                    
                    if (diffDays > DAY_RESET_THRESHOLD) {
                        // Reset rule: Gap > 7 days starts a new Day 1 cycle
                        newDayNumber = 1;
                    } else if (diffDays > 0) {
                        // Sequential Rule: new day number = last event's number + date difference
                        const lastEvent = eventsWithDay[eventsWithDay.length - 1];
                        newDayNumber = lastEvent.dayNumber + diffDays;
                    } else {
                        // Same day events: Keep the last assigned day number
                        const lastEvent = eventsWithDay[eventsWithDay.length - 1];
                        newDayNumber = lastEvent.dayNumber;
                    }
                }
                
                const newEvent = { ...event, dayNumber: newDayNumber };
                eventsWithDay.push(newEvent);
                lastDate = currentDate; 
            }

            return eventsWithDay;
        }


        function renderCalendarSummary() {
            const listEl = document.getElementById('calendarSummaryList');
            const messageEl = document.getElementById('emptyCalendarMessage');
            listEl.innerHTML = '';
            
            // Events must be calculated for day number first
            const allEventsWithDay = calculateSequentialDays(eventSchedule);
            const allEventsWithBlock = allEventsWithDay.map(assignFullMoonBlock);


            if (allEventsWithBlock.length === 0) {
                messageEl.classList.remove('hidden');
                return;
            }
            
            const todayISO = getTodayIsoString();
            
            // --- 1. Group by Year and Block ---
            const groupedByYear = allEventsWithBlock.reduce((acc, event) => {
                const year = new Date(event.date + 'T00:00:00').getFullYear();
                if (!acc[year]) acc[year] = {};

                // Use the blockKey (peak ISO) for grouping
                const blockKey = event.blockKey;
                
                if (!acc[year][blockKey]) acc[year][blockKey] = { 
                    title: event.blockName, // Uses the simplified name
                    events: [],
                };
                
                acc[year][blockKey].events.push(event);
                return acc;
            }, {});

            
            // --- 2. Rendering Logic ---
            const renderGroup = (title, events, isCollapsed = false, containerId) => {
                if (events.length === 0) return '';
                
                const groupId = `calendar-group-${containerId}`;
                let html = '';
                
                // Determine if block is entirely in the past for coloring/labeling
                const isPast = events.every(e => e.date < todayISO);

                html += `
                    <button onclick="toggleCollapsible('${groupId}', this)" class="collapsible-btn bg-gray-100 hover:bg-gray-200 mt-4" data-state="${isCollapsed ? 'collapsed' : 'expanded'}">
                        ${title} (${events.length} events) ${isPast ? '<span class="text-xs text-gray-500 ml-2">(Past)</span>' : ''}
                        <svg class="w-4 h-4 transform transition-transform ${isCollapsed ? '' : 'rotate-180'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="${groupId}" class="${isCollapsed ? 'hidden' : ''} space-y-3 p-2 border border-gray-200 rounded-lg">
                `;
                
                // Group the events within the block by date
                const groupedByDate = events.reduce((acc, event) => {
                    const dateKey = event.date;
                    if (!acc[dateKey]) acc[dateKey] = [];
                    acc[dateKey].push(event);
                    return acc;
                }, {});

                for (const dateKey of Object.keys(groupedByDate).sort()) {
                    const dateGroup = groupedByDate[dateKey];
                    const friendlyDate = dateGroup[0].inputDateFriendly.toUpperCase().replace(/\, \d{4}/, ''); // e.g., SAT, OCT 15
                    
                    html += `<h4 class="text-sm font-semibold text-gray-900 mt-2">${friendlyDate}:</h4>`;
                    
                    dateGroup.forEach(event => {
                        html += `<p class="text-xs text-gray-700 ml-2">Day ${event.dayNumber}: ${event.location} - ${event.eventName}</p>`;
                    });
                }
                
                html += '</div>';
                return html;
            };

            // Main Render Loop (Year by Year)
            const yearKeys = Object.keys(groupedByYear).sort();
            
            yearKeys.forEach((yearKey, yearIndex) => {
                const yearEvents = groupedByYear[yearKey];
                
                const yearId = `year-${yearKey}`;
                const isCurrentYear = yearKey === new Date().getFullYear().toString();
                const isYearCollapsed = !isCurrentYear; // Collapse all years except the current one

                
                // Year Header Button
                const yearButton = document.createElement('button');
                yearButton.className = 'collapsible-btn bg-primary text-white hover:bg-indigo-600 w-full mt-6';
                yearButton.setAttribute('data-state', isYearCollapsed ? 'collapsed' : 'expanded');
                yearButton.setAttribute('onclick', `toggleCollapsible('${yearId}', this)`);
                yearButton.innerHTML = `YEAR ${yearKey} <svg class="w-4 h-4 transform transition-transform ${isYearCollapsed ? '' : 'rotate-180'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                listEl.appendChild(yearButton);

                const yearContent = document.createElement('div');
                yearContent.id = yearId;
                yearContent.className = isYearCollapsed ? 'hidden space-y-4 p-4 border border-primary/50 rounded-b-lg' : 'space-y-4 p-4 border border-primary/50 rounded-b-lg';
                
                // Sort blocks by date of peak
                const sortedBlockKeys = Object.keys(yearEvents).sort();

                sortedBlockKeys.forEach(blockKey => {
                    const block = yearEvents[blockKey];
                    
                    // Render block, collapse if it's not the current year
                    yearContent.innerHTML += renderGroup(
                        block.title, 
                        block.events, 
                        isYearCollapsed, 
                        `${yearKey}-${blockKey.replace(/[^a-zA-Z0-9]/g, '')}`
                    );
                });

                listEl.appendChild(yearContent);
            });
            
            messageEl.classList.toggle('hidden', allEventsWithBlock.length > 0);
        }

        // --- DATA MANAGEMENT: NAME-TAG DB ---

        function setStatus(elementId, message, isError = false) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.textContent = message;
            el.className = `text-xs mt-1 ${isError ? 'text-red-600' : 'text-secondary'}`;
        }

        function copyInitialInstaMap() {
            const mapJson = JSON.stringify(getInitialInstaMap(), null, 2);
            copyToClipboard(mapJson);
            setStatus('bulkStatus', 'Default map copied to clipboard. Paste into the box above.');
        }

        async function bulkImportTags() {
            const inputStr = document.getElementById('bulkInstaMapInput').value.trim();
            
            if (!inputStr) {
                setStatus('bulkStatus', 'Error: Paste data before importing.', true);
                return;
            }

            try {
                let importedData = {};
                
                // Attempt 1: JSON Parse
                try {
                    importedData = JSON.parse(inputStr);
                    if (typeof importedData !== 'object' || Array.isArray(importedData)) {
                         throw new Error("JSON format invalid. Expecting an object map.");
                    }
                } catch(e) {
                    // Attempt 2: Spreadsheet (TSV/CSV) Parse
                    console.log("JSON parsing failed, attempting spreadsheet parse...");
                    const lines = inputStr.split('\n').filter(line => line.trim().length > 0);
                    
                    if(lines.length === 0) throw new Error("Could not parse data as JSON or Spreadsheet.");

                    lines.forEach(line => {
                        // Detect separator (tab or comma)
                        const separator = line.includes('\t') ? '\t' : (line.includes(',') ? ',' : null);
                        
                        const parts = line.split(separator || ' ').map(p => p.trim()).filter(p => p.length > 0);
                        if (parts.length < 2) return; 

                        const name = parts[0];
                        let tag = parts[1];
                        const category = parts[2] || 'Other';
                        
                        if (!name || !tag) return;

                        if (!tag.startsWith('@') && !tag.startsWith('#')) {
                            tag = '@' + tag;
                        }
                        importedData[name] = { tag: tag, category: category };
                    });

                    if (Object.keys(importedData).length === 0) throw new Error("No valid data found in input.");
                }
                
                // FIX: Merge logic: Overwrite existing keys, keep non-colliding keys
                const mergedData = { ...nameTagDatabase, ...importedData };
                
                // Final validation
                for (const key in mergedData) {
                    const item = mergedData[key];
                    if (!item || typeof item.tag !== 'string' || typeof item.category !== 'string') {
                         throw new Error(`Invalid structure for key "${key}". Must contain "tag" and "category".`);
                    }
                }
                
                // Update global map and save
                for (const prop in nameTagDatabase) { delete nameTagDatabase[prop]; }
                Object.assign(nameTagDatabase, mergedData);
                
                await saveDataToFirestore(DB_CONFIG.INSTA_DB_KEY, nameTagDatabase);
                
                document.getElementById('bulkInstaMapInput').value = '';

                setStatus('bulkStatus', `Success! Merged ${Object.keys(importedData).length} entries and saved to cloud.`);
                
            } catch (e) {
                setStatus('bulkStatus', `Import Error: ${e.message}`, true);
            }
        }
        
        async function addNameMapEntry() {
            const name = document.getElementById('newName').value.trim();
            let tag = document.getElementById('newTag').value.trim();
            const category = document.getElementById('newCategory').value;
            const statusEl = document.getElementById('addStatus');

            if (!name || !tag || !category) {
                setStatus('addStatus', 'Error: All fields are required.', true);
                return;
            }
            if (!tag.startsWith('@') && !tag.startsWith('#')) {
                tag = '@' + tag;
            }
            if (nameTagDatabase[name]) {
                setStatus('addStatus', `Error: Name "${name}" already exists. Edit it instead.`, true);
                return;
            }

            nameTagDatabase[name] = { tag, category };
            await saveDataToFirestore(DB_CONFIG.INSTA_DB_KEY, nameTagDatabase);
            
            document.getElementById('newName').value = '';
            document.getElementById('newTag').value = '';
            setStatus('addStatus', `Entry "${name}" saved successfully.`);
        }


        function renderNameMap() {
            const listEl = document.getElementById('databaseList');
            const searchVal = document.getElementById('nameSearch').value.toLowerCase();
            const filterCat = document.getElementById('categoryFilter').value;
            
            if (!listEl) return; 
            
            listEl.innerHTML = '';
            
            const entries = Object.entries(nameTagDatabase).map(([name, data]) => ({
                name: name,
                tag: data.tag,
                category: data.category || 'Other'
            }));
            
            const filteredEntries = entries.filter(entry => {
                const nameMatch = entry.name.toLowerCase().includes(searchVal) || entry.tag.toLowerCase().includes(searchVal);
                const categoryMatch = !filterCat || entry.category === filterCat;
                return nameMatch && categoryMatch;
            });

            filteredEntries.sort((a, b) => a.name.localeCompare(b.name));

            filteredEntries.forEach(({ name, tag, category }) => {
                const isEditing = name === currentEditingName;

                const li = document.createElement('li');
                li.className = 'compact-list-item flex justify-between items-center text-xs'; 
                
                if (isEditing) {
                    li.innerHTML = `
                        <div class="flex-1 min-w-0 pr-1 space-y-1">
                            <input type="text" id="editName-${name}" value="${name}" placeholder="Name" 
                                class="font-medium text-gray-900 w-full bg-white border border-secondary rounded p-1 text-xs focus:ring-secondary focus:border-secondary"> 
                            <div class="flex items-center space-x-1">
                                <input type="text" id="editTag-${name}" value="${tag}" placeholder="Tag"
                                    class="flex-1 bg-white border border-secondary rounded p-1 text-xs text-secondary focus:ring-secondary focus:border-secondary">
                                <select id="editCategory-${name}"
                                        class="bg-white border border-secondary rounded p-1 text-xs text-gray-500 focus:ring-secondary focus:border-secondary flex-shrink-0 w-16">
                                    ${CATEGORIES.map(c => `<option value="${c}" ${c === category ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 flex-shrink-0">
                            <button onclick="saveNameMapEdit('${name}')" class="text-secondary hover:text-emerald-700 p-1 rounded hover:bg-emerald-50 transition" title="Save Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                            <button onclick="cancelNameMapEdit()" class="text-gray-500 hover:text-gray-700 p-1 rounded hover:bg-gray-50 transition" title="Cancel Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    `;
                } else {
                    li.innerHTML = `
                        <div class="flex-1 min-w-0 pr-1 truncate space-y-0">
                            <span class="font-medium text-gray-900">${name}</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-secondary">${tag}</span>
                                <span class="text-gray-500 text-xs">(${category})</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 flex-shrink-0">
                            <button onclick="startNameMapEdit('${name}')" class="text-primary hover:text-indigo-600 p-1 rounded hover:bg-indigo-50 transition" title="Edit Entry">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button onclick="copyToClipboard('${tag}')" class="text-primary hover:text-indigo-600 p-1 rounded hover:bg-indigo-50 transition" title="Copy Tag">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2"></path></svg>
                            </button>
                            <button data-name="${name}" onclick="handleDeleteNameMapEntry(this)" class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition" title="Remove Entry">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                }
                listEl.appendChild(li);
            });
            
            document.getElementById('emptyListMessage').classList.toggle('hidden', filteredEntries.length > 0);
        }
        
        function startNameMapEdit(name) {
            currentEditingName = name;
            renderNameMap();
        }

        function cancelNameMapEdit() {
            currentEditingName = null;
            renderNameMap();
        }

        async function saveNameMapEdit(oldName) {
            const newName = document.getElementById(`editName-${oldName}`).value.trim();
            let newTag = document.getElementById(`editTag-${oldName}`).value.trim();
            const newCategory = document.getElementById(`editCategory-${oldName}`).value;
            const statusEl = document.getElementById('addStatus'); // Reuse status for feedback

            if (!newName || !newTag || !newCategory) {
                setStatus('addStatus', "Error: All fields are required.", true);
                return;
            }
            if (!newTag.startsWith('@') && !newTag.startsWith('#')) {
                newTag = '@' + newTag;
            }

            if (newName !== oldName && nameTagDatabase[newName]) {
                setStatus('addStatus', 'Error: New name already exists!', true);
                return;
            }

            const data = nameTagDatabase[oldName];

            if (oldName !== newName) {
                delete nameTagDatabase[oldName];
                nameTagDatabase[newName] = { tag: newTag, category: newCategory };
            } else {
                 nameTagDatabase[oldName].tag = newTag;
                 nameTagDatabase[oldName].category = newCategory;
            }
            
            currentEditingName = null;
            await saveDataToFirestore(DB_CONFIG.INSTA_DB_KEY, nameTagDatabase);
            setStatus('addStatus', `Entry "${newName}" updated successfully.`);
        }

        async function handleDeleteNameMapEntry(button) {
            const nameToRemove = button.getAttribute('data-name');
            const confirmed = await openModal(`Are you sure you want to permanently delete the tag entry for "${nameToRemove}"?`);

            if (confirmed) {
                delete nameTagDatabase[nameToRemove];
                await saveDataToFirestore(DB_CONFIG.INSTA_DB_KEY, nameTagDatabase);
            }
        }
        
        async function saveGlobalHashtags() {
            const tags = document.getElementById('defaultTagsInput').value.trim();
            if (tags === globalTagsString) return;

            window.globalTagsString = tags;
            await saveDataToFirestore(DB_CONFIG.GLOBAL_TAGS_KEY, tags);
            setStatus('globalTagsStatus', 'Global tags saved!');
            
            document.getElementById('defaultTagsInput').value = globalTagsString;
        }
        
        function renderGlobalTags() {
            const inputEl = document.getElementById('defaultTagsInput');
            if (inputEl) {
                inputEl.value = globalTagsString;
            }
        }


        // --- DATA MANAGEMENT: SCHEDULER & HISTORY ---

        function initializeSortable() {
            const list = document.getElementById('scheduledEventsList');
            if (Sortable.get(list)) {
                Sortable.get(list).destroy();
            }
            if (!list) return; 

            new Sortable(list, {
                animation: 150,
                ghostClass: 'sortable-drag',
                onEnd: async function (evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    // We only reorder the upcoming events currently visible in the schedule tab
                    const today = getTodayIsoString();
                    const upcomingEvents = eventSchedule.filter(event => event.date > today);
                    
                    const [movedItem] = upcomingEvents.splice(oldIndex, 1);
                    upcomingEvents.splice(newIndex, 0, movedItem);
                    
                    // Rebuild the master schedule list: past events + reordered upcoming events
                    const pastEvents = eventSchedule.filter(event => event.date <= today);
                    const newSchedule = [...pastEvents, ...upcomingEvents];

                    // IMPORTANT: Reset eventSchedule to ensure listeners pick up the full new array, sorted by date for safety.
                    eventSchedule.splice(0, eventSchedule.length, ...newSchedule.sort((a, b) => new Date(a.date) - new Date(b.date)));
                    
                    await saveDataToFirestore(DB_CONFIG.SCHEDULE_DB_KEY, eventSchedule);
                    // Re-render is handled by Firestore listener
                },
            });
        }
        
        function renderScheduleList() {
            const listEl = document.getElementById('scheduledEventsList');
            const historyListEl = document.getElementById('historyEventsList');
            const messageEl = document.getElementById('emptyScheduleMessage');
            const today = getTodayIsoString();
            
            if (!listEl || !historyListEl || !messageEl) return;
            
            listEl.innerHTML = '';
            historyListEl.innerHTML = '';
            
            // 1. Calculate Day Numbers across ALL events (CRITICAL FIX)
            const allEventsWithDay = calculateSequentialDays(eventSchedule);

            // 2. Separate events based on date: Before Today = History, Today or After = Schedule
            const upcomingEvents = [];
            const pastEvents = [];

            allEventsWithDay.forEach(event => {
                // FIX: Use strict string comparison for reliable segregation
                if (event.date < today) { // Event date is before today -> History
                    pastEvents.push(event);
                } else { // Event date is today or after -> Schedule
                    upcomingEvents.push(event);
                }
            });
            
            // --- Render Schedule Tab ---
            if (upcomingEvents.length === 0) {
                messageEl.classList.remove('hidden');
            } else {
                messageEl.classList.add('hidden');
            }

            upcomingEvents.forEach((event, index) => {
                
                const dayPrefix = `ðŸŒ•Full Moon Week - Day ${event.dayNumber}ðŸŒ•\n`;
                // The stored postText does NOT include the prefix
                const finalPostText = dayPrefix + event.postText; 
                
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-lg bg-white shadow-sm space-y-3 cursor-grab';
                div.onclick = () => loadEventForEdit(event); // ADDED: Load event into editor on click
                
                // Editable ID setup (index relative to the upcomingEvents array)
                const postTextId = `schedule-post-text-${index}`;
                const tagsOnlyId = `schedule-tags-only-${index}`;

                div.innerHTML = `
                    <div class="flex justify-between items-start flex-wrap">
                        <div class="flex-grow min-w-0 pr-4 flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                            <h3 class="text-lg font-bold text-primary inline">${event.eventName} <span class="text-gray-500 font-medium ml-2 text-sm">| Day ${event.dayNumber}</span></h3>
                            <p class="text-xs text-gray-700 inline-block mt-1 sm:mt-0 flex-wrap flex">
                                ðŸ—“ Date: ${event.inputDateFriendly}
                                ${window.mediaFolderLink ? `<a href="${window.mediaFolderLink}" target="_blank" class="text-blue-600 underline hover:text-blue-800 ml-2">Open Media Folder</a>` : ''}
                            </p>
                        </div>
                        
                        <div class="flex space-x-2 flex-shrink-0 mt-2 sm:mt-0">
                            <button onclick="event.stopPropagation(); saveEventAsTemplate(event)" class="text-sm px-3 py-1 bg-gray-500 text-white rounded-full hover:bg-gray-600 transition">Save as Template</button>
                            <button onclick="event.stopPropagation(); copyToClipboard(document.getElementById('${postTextId}').value)" class="text-sm px-3 py-1 bg-primary text-white rounded-full hover:bg-indigo-600 transition">Copy Post</button>
                            <button onclick="event.stopPropagation(); copyToClipboard(document.getElementById('${tagsOnlyId}').value)" class="text-sm px-3 py-1 bg-secondary text-white rounded-full hover:bg-emerald-600 transition">Copy Tags</button>
                            <button onclick="event.stopPropagation(); handleDeleteScheduledEvent(${index})" class="text-red-500 hover:text-red-700 p-1 transition" title="Delete Event">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-2">
                        <div class="col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Post/Reel Text:</label>
                            <textarea 
                                id="${postTextId}" 
                                onblur="updateScheduledEventText(${index}, this.value, 'postText', 'upcoming')" 
                                class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-primary focus:border-primary" rows="6"
                            >${finalPostText}</textarea>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700">Story Tags:</label>
                            <textarea 
                                id="${tagsOnlyId}" 
                                onblur="updateScheduledEventText(${index}, this.value, 'tagsOnly', 'upcoming')" 
                                class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-primary focus:border-primary" rows="6"
                            >${event.tagsOnly}</textarea>
                        </div>
                    </div>
                `;
                listEl.appendChild(div);
            });
            
            // --- Render History Tab ---
            renderHistoryList(pastEvents);
        }
        
        async function updateScheduledEventText(index, value, field, type) {
            
            const today = getTodayIsoString();
            
            // Find the correct array based on type
            const targetArray = type === 'upcoming' 
                ? eventSchedule.filter(event => event.date >= today) // Note: This check is different from the one in renderScheduleList
                : eventSchedule.filter(event => event.date < today);

            if (index < 0 || index >= targetArray.length) return;
            
            // Find the original item in the full eventSchedule list to update
            const itemToUpdate = targetArray[index];
            const globalIndex = eventSchedule.findIndex(e => e.date === itemToUpdate.date && e.eventName === itemToUpdate.eventName);


            if (globalIndex === -1) {
                console.error("Critical: Could not find event in global list to update.");
                return;
            }

            if (field === 'postText') {
                // Strip the dynamic Day prefix before saving to database
                const dayPrefixRegex = /ðŸŒ•Full Moon Week - Day \d+ðŸŒ•\n?/;
                const strippedValue = value.replace(dayPrefixRegex, '').trim();
                eventSchedule[globalIndex].postText = strippedValue;
            } else {
                eventSchedule[globalIndex][field] = value;
            }
            
            await saveDataToFirestore(DB_CONFIG.SCHEDULE_DB_KEY, eventSchedule);
        }

        async function handleDeleteScheduledEvent(index) {
            const today = getTodayIsoString();
            const upcomingEvents = eventSchedule.filter(event => event.date >= today); // Events for Today or After
            
            if (index < 0 || index >= upcomingEvents.length) return;

            const eventToDelete = upcomingEvents[index];
            const confirmed = await openModal(`Delete scheduled event: "${eventToDelete.eventName}"?`);

            if (confirmed) {
                const globalIndex = eventSchedule.findIndex(e => e.date === eventToDelete.date && e.eventName === eventToDelete.eventName);
                if (globalIndex > -1) {
                    eventSchedule.splice(globalIndex, 1); 
                    await saveDataToFirestore(DB_CONFIG.SCHEDULE_DB_KEY, eventSchedule);
                }
            }
        }
        
        function renderHistoryList(pastEvents = []) {
            const listEl = document.getElementById('historyEventsList');
            const messageEl = document.getElementById('emptyHistoryMessage');

            if (!listEl || !messageEl) return;
            
            listEl.innerHTML = '';

            if (pastEvents.length === 0) {
                messageEl.classList.remove('hidden');
                return;
            }
            messageEl.classList.add('hidden');

            pastEvents.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Group by Month/Year for optimization
            const groupedHistory = pastEvents.reduce((acc, event) => {
                const date = new Date(event.date + 'T00:00:00');
                const groupKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                if (!acc[groupKey]) {
                    acc[groupKey] = [];
                }
                acc[groupKey].push(event);
                return acc;
            }, {});
            
            let isFirstGroup = true;

            for (const groupKey in groupedHistory) {
                const group = groupedHistory[groupKey];
                const groupId = `history-group-${groupKey.replace(/\s/g, '-')}`;
                const isExpanded = isFirstGroup;
                isFirstGroup = false;

                const button = document.createElement('button');
                button.className = 'collapsible-btn mt-6';
                button.setAttribute('data-state', isExpanded ? 'expanded' : 'collapsed');
                button.setAttribute('onclick', `toggleCollapsible('${groupId}', this)`);
                button.innerHTML = `${groupKey} (${group.length} events) <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                listEl.appendChild(button);

                const groupContent = document.createElement('div');
                groupContent.id = groupId;
                groupContent.className = isExpanded ? 'space-y-3 p-2' : 'hidden space-y-3 p-2';
                
                group.forEach((event, index) => {
                    const uniqueId = `history-detail-${event.date}-${index}`; // Unique ID for details toggle
                    const dayPrefix = `ðŸŒ•Day ${event.dayNumber}ðŸŒ•`;

                    const div = document.createElement('div');
                    div.className = 'p-3 border border-gray-200 rounded-lg bg-white shadow-sm text-sm';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-grow min-w-0 pr-4">
                                <h3 class="font-bold text-gray-800">${event.eventName} <span class="text-gray-500 font-medium ml-2 text-sm">${dayPrefix}</span></h3>
                                <p class="text-xs text-gray-600">ðŸ—“ ${event.inputDateFriendly} | ðŸ“ ${event.location}</p>
                            </div>
                            
                            <div class="flex space-x-2 flex-shrink-0">
                                <button onclick="toggleCollapsible('${uniqueId}', this)" class="text-xs px-2 py-1 bg-gray-400 text-white rounded hover:bg-gray-500 transition" data-state="collapsed">View Details</button>
                                <button onclick="duplicateToEditor(${JSON.stringify(event).replace(/"/g, '&quot;')})" class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-indigo-600 transition">Duplicate</button>
                                <button onclick="event.stopPropagation(); saveEventAsTemplate(event)" class="text-xs px-2 py-1 bg-gray-500 text-white rounded-full hover:bg-gray-600 transition">Save as Template</button>
                                <button onclick="handleDeleteHistoryEvent(${index}, '${groupKey}')" class="text-red-500 hover:text-red-700 p-1 transition" title="Delete History Event">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div id="${uniqueId}" class="mt-3 p-3 bg-gray-100 rounded-lg hidden w-full">
                            <p class="text-xs font-medium text-gray-700 mb-1">Post Text:</p>
                            <pre class="whitespace-pre-wrap text-xs bg-white p-2 rounded">${event.postText}</pre>
                            <p class="text-xs font-medium text-gray-700 mt-2 mb-1">Story Tags:</p>
                            <pre class="whitespace-pre-wrap text-xs bg-white p-2 rounded">${event.tagsOnly}</pre>
                        </div>
                    `;
                    groupContent.appendChild(div);
                });

                listEl.appendChild(groupContent);
            }
            listEl.dataset.pastEvents = JSON.stringify(pastEvents);
        }
        
        async function handleDeleteHistoryEvent(index, groupKey) {
            // Re-extract the current pastEvents list for accurate indexing
            const pastEventsJson = document.getElementById('historyEventsList').dataset.pastEvents;
            const fullHistory = JSON.parse(pastEventsJson);

            if (index >= fullHistory.length) return;

            const eventToRemove = fullHistory[index];
            const confirmed = await openModal(`Delete historical event: "${eventToRemove.eventName}" from ${groupKey}?`);

            if (confirmed) {
                // Find the index of this event in the main eventSchedule 
                const globalIndex = eventSchedule.findIndex(e => e.date === eventToRemove.date && e.eventName === eventToRemove.eventName);
                if (globalIndex > -1) {
                    eventSchedule.splice(globalIndex, 1);
                    await saveDataToFirestore(DB_CONFIG.SCHEDULE_DB_KEY, eventSchedule);
                }
            }
        }
        
        // ADDED: New function to load scheduled event back to editor
        function loadEventForEdit(event) {
             // Load content into the editor tab fields
            document.getElementById('inputEventName').value = event.eventName;
            document.getElementById('inputLocation').value = event.location;
            document.getElementById('inputIsoDate').value = event.date;
            
            // Strip structural headers and hashtags from postText before loading to rawDescription
            const rawDescription = event.postText
                .replace(/^ðŸ—“ DATE:.*\n/, '')
                .replace(/^ðŸŽ‰ EVENT:.*\n/, '')
                .replace(/^ðŸ“ LOCATION:.*\n/, '')
                .replace(/#\w+/g, '') // Remove all hashtags
                .trim();

            document.getElementById('rawDescription').value = rawDescription;
            // Note: Cannot easily determine original extraHashtags, so clearing it for manual re-entry

            // Switch to editor tab
            showTab('editor');
        }

        // ADDED: Function to save content as template from Schedule/History
        async function saveEventAsTemplate(event) {
            // FIX: Use custom modal instead of prompt()
            const templateName = await openPromptModal("Enter a name for this template:");
            
            if (!templateName || templateName.trim() === "") return;

            const eventName = event.eventName;
            const location = event.location;
            
            // Strip structural headers and hashtags from postText before saving to description
            const description = event.postText
                .replace(/^ðŸ—“ DATE:.*\n/, '')
                .replace(/^ðŸŽ‰ EVENT:.*\n/, '')
                .replace(/^ðŸ“ LOCATION:.*\n/, '')
                .replace(/#\w+/g, '') // Remove all hashtags
                .trim();

            eventDatabase[templateName] = {
                location: location,
                eventName: eventName,
                description: description
            };

            await saveDataToFirestore(DB_CONFIG.EVENT_DB_KEY, eventDatabase);
            
            // Provide feedback via console and status bar if open
            console.log(`Template "${templateName}" saved!`);
            
            // Update the settings status if the template management section is visible
            setStatus('eventTemplateStatus', `Template "${templateName}" saved successfully.`);
        }

        function duplicateToEditor(event) {
            // Load content into the editor tab fields
            document.getElementById('inputEventName').value = event.eventName;
            document.getElementById('inputLocation').value = event.location;
            
            // Strip structural headers and hashtags from postText before loading to rawDescription
            const rawDescription = event.postText
                .replace(/^ðŸ—“ DATE:.*\n/, '')
                .replace(/^ðŸŽ‰ EVENT:.*\n/, '')
                .replace(/^ðŸ“ LOCATION:.*\n/, '')
                .replace(/#\w+/g, '') // Remove all hashtags
                .trim();

            document.getElementById('rawDescription').value = rawDescription;
            document.getElementById('inputIsoDate').value = ""; // Clear date to force new date selection
            document.getElementById('extraHashtagsInput').value = ""; // Clear extra hashtags

            // Switch to editor tab
            showTab('editor');
        }

        // --- DATA MANAGEMENT: SNIPPETS & TEMPLATES (Remaining functions implemented below) ---
        
        function renderEditorSnippetSelect() {
            const selectEl = document.getElementById('editorSnippetSelect');
            if (!selectEl) return;
            
            selectEl.innerHTML = '<option value="">--- Select Snippet ---</option>';
            const names = Object.keys(textSnippets).sort();
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selectEl.appendChild(option);
            });
        }
        
        function insertSnippet() {
            const selectEl = document.getElementById('editorSnippetSelect');
            const name = selectEl.value;
            const descriptionEl = document.getElementById('rawDescription');

            if (name && textSnippets[name]) {
                const start = descriptionEl.selectionStart;
                const end = descriptionEl.selectionEnd;
                const value = descriptionEl.value;
                
                // Insert text at cursor position
                descriptionEl.value = value.substring(0, start) + textSnippets[name] + value.substring(end);
                
                // Move cursor after the inserted text
                descriptionEl.selectionStart = descriptionEl.selectionEnd = start + textSnippets[name].length;

                document.getElementById('snippetMenu').classList.add('hidden');
            }
            selectEl.value = ''; 
        }
        
        function renderSnippetSelect() {
            const selectEl = document.getElementById('snippetSelect');
            if (!selectEl) return;
            
            selectEl.innerHTML = '<option value="">--- Load Snippet ---</option>';
            const names = Object.keys(textSnippets).sort();
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selectEl.appendChild(option);
            });
        }

        function loadSnippet() {
            const name = document.getElementById('snippetSelect').value;
            const contentEl = document.getElementById('snippetContent');
            const nameInputEl = document.getElementById('snippetName');
            
            if (name && textSnippets[name]) {
                contentEl.value = textSnippets[name];
                nameInputEl.value = name;
            } else {
                contentEl.value = '';
                nameInputEl.value = '';
            }
        }

        async function saveSnippet() {
            const name = document.getElementById('snippetName').value.trim();
            const content = document.getElementById('snippetContent').value.trim();
            const statusEl = document.getElementById('snippetStatus');

            if (!name || !content) {
                setStatus('snippetStatus', 'Name and content are required.', true);
                return;
            }

            textSnippets[name] = content;
            await saveDataToFirestore(DB_CONFIG.SNIPPETS_KEY, textSnippets);
            setStatus('snippetStatus', `Snippet "${name}" saved!`);
        }

        async function removeSnippet(button) {
            const nameToRemove = button.getAttribute('data-name');
            const confirmed = await openModal(`Are you sure you want to remove snippet "${nameToRemove}"?`);

            if(confirmed) {
                delete textSnippets[nameToRemove];
                await saveDataToFirestore(DB_CONFIG.SNIPPETS_KEY, textSnippets);
            }
        }
        
        function renderEventTemplateSelect() {
            const selectEl = document.getElementById('eventTemplateSelect');
            const listEl = document.getElementById('eventDbList');
            if (!selectEl || !listEl) return; 
            
            selectEl.innerHTML = '<option value="">--- Select Event Template ---</option>';
            listEl.innerHTML = '';

            const names = Object.keys(eventDatabase).sort();
            
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selectEl.appendChild(option);

                const div = document.createElement('div');
                div.className = 'flex justify-between items-center py-1';
                div.innerHTML = `
                    <span class="text-gray-800">${name}</span>
                    <button data-name="${name}" onclick="removeEventTemplate(this)" class="text-red-500 hover:text-red-700 ml-4 text-xs">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                listEl.appendChild(div);
            });
        }

        async function saveEventTemplate() {
            const name = document.getElementById('eventDbName').value.trim();
            const location = document.getElementById('inputLocation').value.trim();
            const eventName = document.getElementById('inputEventName').value.trim();
            const description = document.getElementById('rawDescription').value.trim();
            const statusEl = document.getElementById('eventTemplateStatus');

            if (!name || !location) {
                setStatus('eventTemplateStatus', "Error: Please enter a Template Name and Location to save the template.", true);
                return;
            }

            eventDatabase[name] = {
                location: location,
                eventName: eventName,
                description: description
            };

            document.getElementById('eventDbName').value = '';
            await saveDataToFirestore(DB_CONFIG.EVENT_DB_KEY, eventDatabase);
            setStatus('eventTemplateStatus', `Template "${name}" saved!`);
        }

        function loadEventTemplate() {
            const name = document.getElementById('eventTemplateSelect').value;
            if (name && eventDatabase[name]) {
                const template = eventDatabase[name];
                
                document.getElementById('inputIsoDate').value = ""; 
                document.getElementById('inputEventName').value = template.eventName || name; // Use saved eventName, or template name as fallback
                document.getElementById('inputLocation').value = template.location;
                // Note: Global tags are loaded from settings directly, not saved in the template.
                document.getElementById('rawDescription').value = template.description;

                document.getElementById('statusMessage').textContent = `Template "${name}" loaded.`;
                document.getElementById('statusMessage').className = 'mt-4 sm:mt-0 text-sm text-primary font-bold w-full text-center sm:text-left';
            }
        }

        async function removeEventTemplate(button) {
            const nameToRemove = button.getAttribute('data-name');
            const confirmed = await openModal(`Are you sure you want to remove template "${nameToRemove}"?`);

            if(confirmed) {
                delete eventDatabase[nameToRemove];
                await saveDataToFirestore(DB_CONFIG.EVENT_DB_KEY, eventDatabase);
                setStatus('eventTemplateStatus', `Template "${nameToRemove}" removed.`);
            }
        }
        
        function renderMediaLink() {
            const linkEl = document.getElementById('mediaFolderLink');
            if (linkEl) { 
                linkEl.value = mediaFolderLink;
            }
        }
        
        async function saveMediaFolderLink() {
            const link = document.getElementById('mediaFolderLink').value.trim();
            const statusEl = document.getElementById('mediaLinkStatus');
            
            if (!link || !link.startsWith('http')) {
                setStatus('mediaLinkStatus', "Error: Please enter a valid link (must start with http).", true);
                return;
            }
            
            window.mediaFolderLink = link;
            await saveDataToFirestore(DB_CONFIG.MEDIA_LINK_KEY, link); 
            
            setStatus('mediaLinkStatus', 'Media folder link saved!');
        }
        
        // --- CORE PARSING LOGIC (FINALIZED) ---

        function processStructuredEvent(structuredData, description, extraHashtags, instaMap, defaultHashtags) {
            
            let allTagsWithOrder = []; 
            const existingTags = new Set(); 
            const block = description; 
            
            // 1. Extract existing tags (@user) from description and record their index (order)
            const tagMatches = Array.from(block.matchAll(/@(\w+\.?\w+)/g));
            
            tagMatches.forEach(match => {
                const tag = match[0].toLowerCase();
                if (!existingTags.has(tag)) {
                    allTagsWithOrder.push({ tag: tag, index: match.index });
                    existingTags.add(tag);
                }
            });

            // --- Inject tags into the description ---
            let postDescription = description;
            const sortedNames = Object.keys(instaMap).sort((a, b) => b.length - a.length); 

            sortedNames.forEach(name => {
                const tagToInject = instaMap[name].tag;
                const tagToInjectLower = tagToInject.toLowerCase();

                if (existingTags.has(tagToInjectLower)) {
                    return; 
                }

                const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const injectionRegex = new RegExp(`(\\b${escapedName}\\b)(?!\\s*@\\w+)`, 'gi'); 
                
                let foundMatchInCurrentIteration = false;

                postDescription = postDescription.replace(injectionRegex, (match, p1) => {
                    if (!foundMatchInCurrentIteration) {
                        existingTags.add(tagToInjectLower); 
                        foundMatchInCurrentIteration = true; 
                        
                        const firstMatchIndex = postDescription.toLowerCase().indexOf(p1.toLowerCase()); 
                        if (firstMatchIndex > -1) {
                           allTagsWithOrder.push({ tag: tagToInjectLower, index: firstMatchIndex });
                        }

                        return `${p1} ${tagToInject}`; 
                    }
                    
                    return p1; 
                });
            });

            
            // 3. Final Tag Consolidation and Ordering 
            const extraTagsArray = extraHashtags.split(',').map(t => `#${t.trim().replace(/^#/, '').toLowerCase()}`).filter(t => t.length > 0);
            
            const defaultHashtagsSet = new Set(defaultHashtags.map(t => `#${t.toLowerCase()}`));
            const finalHashtags = [...defaultHashtagsSet.values(), ...extraTagsArray].filter((tag, index, self) => self.indexOf(tag) === index);
            
            allTagsWithOrder.sort((a, b) => a.index - b.index);
            
            const orderedInstaTags = [];
            const seenAtTags = new Set(); 
            allTagsWithOrder.forEach(item => {
                if (item.tag.startsWith('@') && !seenAtTags.has(item.tag)) {
                    orderedInstaTags.push(item.tag);
                    seenAtTags.add(item.tag);
                }
            });
            
            // 4. Standardized Output Generation (3a)
            const hashtagsOutput = finalHashtags.filter(tag => tag.startsWith('#')).join(' ');

            const dateFriendly = formatDateFriendly(structuredData.isoDate);

            // Output does NOT include the Day X prefix, which is added later for display.
            const basePostText = 
                `ðŸ—“ DATE: ${dateFriendly}\n` + 
                `ðŸŽ‰ EVENT: ${structuredData.eventName}\n` + 
                `ðŸ“ LOCATION: ${structuredData.location}\n` + 
                `\n` +
                postDescription.trim() + 
                `\n\n` +
                `${hashtagsOutput}`;

            return {
                postText: basePostText,
                tagsOnly: orderedInstaTags.join('\n'), 
            };
        }

        // --- MAIN HANDLER ---

        async function handleClick(saveToSchedule) {
            const structuredData = {
                isoDate: document.getElementById('inputIsoDate').value.trim(),
                eventName: document.getElementById('inputEventName').value.trim(),
                location: document.getElementById('inputLocation').value.trim(),
            };
            
            const dateFriendly = formatDateFriendly(structuredData.isoDate);
            const mediaFileName = generateFileName(); 
            const rawDescriptionInput = document.getElementById('rawDescription');
            const description = rawDescriptionInput.value;
            
            const defaultTagsStr = globalTagsString; 
            const extraHashtags = document.getElementById('extraHashtagsInput').value;
            const statusMessage = document.getElementById('statusMessage');

            statusMessage.textContent = 'Processing...';

            const defaultHashtags = defaultTagsStr
                .split(',')
                .map(tag => tag.trim().replace(/^#/, ''))
                .filter(tag => tag.length > 0);

            if (!structuredData.isoDate || !structuredData.eventName || !description.trim()) {
                 statusMessage.className = 'mt-4 sm:mt-0 text-sm text-red-600 font-bold w-full text-center sm:text-left';
                 statusMessage.textContent = 'Error: Date, Event Name, and Description are required fields.';
                 return;
            }

            try {
                const result = processStructuredEvent(structuredData, description, extraHashtags, nameTagDatabase, defaultHashtags);
                
                // The postText doesn't contain the day prefix for saving to the database.
                const finalPostTextForDisplay = `ðŸŒ•Full Moon Week - Day XðŸŒ•\n${result.postText}`;

                // Update output fields
                document.getElementById('calendarOutput').value = finalPostTextForDisplay;
                document.getElementById('tagsOnlyOutput').value = result.tagsOnly;

                if (saveToSchedule) {
                    // If saving, re-read the potentially edited values from the output textareas
                    const savedPostText = document.getElementById('calendarOutput').value.replace(/ðŸŒ•Full Moon Week - Day XðŸŒ•\n?/, '').replace(/ðŸŒ•Full Moon Week - Day \d+ðŸŒ•\n?/, ''); 
                    const savedTagsOnly = document.getElementById('tagsOnlyOutput').value;

                    // FIX: Find if event already exists and update it, instead of pushing a duplicate
                    const existingIndex = eventSchedule.findIndex(e => e.date === structuredData.isoDate && e.eventName === structuredData.eventName);

                    const newEventData = {
                        eventName: structuredData.eventName,
                        date: structuredData.isoDate,
                        location: structuredData.location, 
                        inputDateFriendly: dateFriendly,
                        postText: savedPostText,  
                        tagsOnly: savedTagsOnly,
                        mediaFileName: mediaFileName 
                    };

                    if (existingIndex !== -1) {
                        // Update existing entry
                        eventSchedule[existingIndex] = newEventData;
                        statusMessage.textContent = `Event "${structuredData.eventName}" updated in Scheduler!`;
                    } else {
                        // Push new entry
                        eventSchedule.push(newEventData);
                        statusMessage.textContent = `Event "${structuredData.eventName}" saved to Scheduler!`;
                    }
                    
                    await saveDataToFirestore(DB_CONFIG.SCHEDULE_DB_KEY, eventSchedule);
                    
                    statusMessage.className = 'mt-4 sm:mt-0 text-sm text-accent font-bold w-full text-center sm:text-left';
                    showTab('scheduler');
                } else {
                    statusMessage.className = 'mt-4 sm:mt-0 text-sm text-secondary font-bold w-full text-center sm:text-left';
                    statusMessage.textContent = 'Parsing Complete! Click to Save';
                }

            } catch (e) {
                console.error(e);
                statusMessage.className = 'mt-4 sm:mt-0 text-sm text-red-600 font-bold w-full text-center sm:text-left';
                statusMessage.textContent = `Critical Error: ${e.message}. Check console.`;
            }
        }

        // --- INITIALIZATION ---
        
        function render() {
             renderNameMap();
             renderEventTemplateSelect();
             renderSnippetSelect();
             renderEditorSnippetSelect();
             renderScheduleList();
             renderMediaLink();
             renderGlobalTags();
             renderCalendarSummary(); // RENDER CALENDAR HERE SO IT'S READY ON LOAD
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            // FIX 3: Default to today's date
            document.getElementById('inputIsoDate').value = getTodayIsoString();

            // Clear inputs on load for fresh start
            document.getElementById('inputEventName').value = "";
            document.getElementById('inputLocation').value = "";
            document.getElementById('rawDescription').value = "";
            document.getElementById('extraHashtagsInput').value = "";
            document.getElementById('calendarOutput').value = "";
            document.getElementById('tagsOnlyOutput').value = "";
        });
        
    </script>
</body>
</html>
